<!DOCTYPE html>
<html>
<head>
    <title>Student Learning Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --accent: #00ffcc; --glow: rgba(0, 255, 204, 0.2); --glow-strong: rgba(0, 255, 204, 0.4); }
        body { background-color: #050505; background-image: radial-gradient(circle at center, transparent 0%, #000 90%), linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 100% 100%, 40px 40px, 40px 40px; background-attachment: fixed; color: #fff; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #111; } ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: var(--accent); }
        #menu-container { position: absolute; z-index: 100; background: rgba(0,0,0,0.95); width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .screen { display: none; flex-direction: column; align-items: center; width: 100%; max-width: 1200px; transition: transform 0.3s ease; transform: scale(0.95); }
        .active { display: flex; }
        @media only screen and (max-width: 1400px) { .screen { transform: scale(0.8); transform-origin: center center; } }
        @media only screen and (max-width: 1000px) { .screen { transform: scale(0.65); } }
        h1 { font-size: 60px; margin-bottom: 30px; letter-spacing: 4px; text-align: center; font-weight: 900; text-transform: uppercase; }
        h1 span { background: linear-gradient(135deg, var(--accent), #fff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 30px var(--glow); animation: titlePulse 3s infinite ease-in-out; }
        @keyframes titlePulse { 0%, 100% { filter: drop-shadow(0 0 10px var(--glow)); } 50% { filter: drop-shadow(0 0 25px var(--accent)); } }
        .user-john { color: #7851a9 !important; font-family: 'Brush Script MT', cursive; font-size: 1.2em; text-shadow: 0 0 5px gold, 0 0 10px gold; animation: goldPulse 2s infinite alternate; }
        @keyframes goldPulse { 0% { text-shadow: 0 0 5px gold; } 100% { text-shadow: 0 0 20px gold, 0 0 10px #ff00ff; } }
        .user-bamba { font-family: 'Courier New', monospace; font-weight: 900; color: #00ffff; text-shadow: 2px 2px 0px #ffff00; display: inline-block; animation: electricGlitch 0.2s infinite; }
        @keyframes electricGlitch { 0% { transform: translate(0,0); text-shadow: 2px 2px 0px #ffff00; color: #00ffff; } 25% { transform: translate(-2px,1px); text-shadow: -2px 2px 0px #0000ff; } 50% { transform: translate(2px,-1px); text-shadow: 0 0 10px #fff; color: #fff; } 75% { transform: translate(0,2px); text-shadow: 2px -2px 0px #0000ff; color: #00ffff; } 100% { transform: translate(0,0); } }
        .user-glitch { font-family: 'Courier New', monospace; color: #00ff41; font-weight: 900; display: inline-block; animation: glitchAnim 0.3s infinite; }
        @keyframes glitchAnim { 0% { text-shadow: 2px 0 red, -2px 0 blue; } 50% { text-shadow: 2px 0 blue, -2px 0 red; transform: translate(1px,-1px); } 100% { text-shadow: 2px 0 red, -2px 0 blue; } }
        .user-inferno { font-family: Impact, sans-serif; background: linear-gradient(to top, #ff0000, #ffcc00); -webkit-background-clip: text; color: transparent; animation: infernoAnim 1.5s infinite alternate; }
        @keyframes infernoAnim { 0% { filter: drop-shadow(0 -2px 2px rgba(255,69,0,0.6)); transform: scale(1); } 100% { filter: drop-shadow(0 -5px 8px rgba(255,69,0,1)); transform: scale(1.05); } }
        .user-diamond { font-family: Georgia, serif; color: #e0f7fa; font-weight: bold; animation: diamondAnim 2s infinite ease-in-out; }
        @keyframes diamondAnim { 0% { text-shadow: 0 0 5px #00ffff; color: #b2ebf2; } 50% { text-shadow: 0 0 20px #fff, 0 0 30px #00ffff; color: #fff; } 100% { text-shadow: 0 0 5px #00ffff; color: #b2ebf2; } }
        .user-gamer { font-family: Verdana, sans-serif; background-image: linear-gradient(45deg, #ff0000, #ffff00, #00ff00, #0000ff, #ff00ff); -webkit-background-clip: text; color: transparent; font-weight: 900; animation: hueRotate 3s infinite linear; }
        @keyframes hueRotate { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }
        .user-synth { font-family: Impact, sans-serif; font-style: italic; background: linear-gradient(180deg, #ff00cc, #3333ff); -webkit-background-clip: text; color: transparent; animation: synthAnim 1s infinite alternate; }
        @keyframes synthAnim { 0% { filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.5)); } 100% { filter: drop-shadow(2px 2px 5px #ff00de); } }
        .user-midas { font-family: Georgia, serif; background: linear-gradient(110deg, #bf953f 20%, #fcf6ba 40%, #bf953f 60%, #aa771c 80%); background-size: 200% auto; -webkit-background-clip: text; color: transparent; font-weight: bold; animation: midasAnim 3s linear infinite; }
        @keyframes midasAnim { to { background-position: 200% center; } }
        .user-sparkle { font-family: 'Georgia', serif; color: #fff; animation: sparkleAnim 1.5s infinite alternate; }
        @keyframes sparkleAnim { 0% { opacity: 1; text-shadow: 0 0 5px #fff, 0 0 10px #ff00de; } 50% { opacity: 0.8; text-shadow: 0 0 20px #fff, 0 0 30px #00ffff; } 100% { opacity: 1; text-shadow: 0 0 5px #fff, 0 0 10px #ff00de; } }

        .tech-panel { background: rgba(10,10,10,0.8); border: 1px solid var(--accent); box-shadow: 0 0 20px var(--glow); border-radius: 8px; padding: 30px; display: flex; flex-direction: column; align-items: center; backdrop-filter: blur(10px); }
        .input-std { background: #111; border: 1px solid #333; color: #fff; padding: 12px; font-size: 18px; border-radius: 4px; margin: 10px 0; width: 300px; text-align: center; transition: 0.3s; }
        .input-std:focus { border-color: var(--accent); box-shadow: 0 0 10px var(--glow); outline: none; background: #000; }
        .btn { padding: 15px 40px; font-size: 16px; cursor: pointer; border: none; font-weight: 800; border-radius: 4px; margin: 8px; width: 300px; text-transform: uppercase; transition: all 0.2s ease-in-out; box-shadow: 0 4px 15px rgba(0,0,0,0.5); letter-spacing: 1px; position: relative; overflow: hidden; }
        .btn:hover { transform: translateY(-2px) scale(1.02); filter: brightness(1.2); letter-spacing: 3px; box-shadow: 0 0 20px var(--glow); }
        .btn-green { background: #00ffcc; color: #000; } .btn-zen { background: #a29bfe; color: #000; } .btn-apm { background: #ff5555; color: #fff; }
        .btn-ffa { background: #ff9900; color: #000; } .btn-blue { background: #00a8ff; color: #fff; } .btn-pink { background: #ff00de; color: #fff; }
        .btn-multi { background: linear-gradient(135deg, #ff9900, #ff00de); color: #fff; }
        .btn-sp { background: linear-gradient(135deg, #a29bfe, #00a8ff); color: #fff; }
        .btn-bug { background: #555; color: #fff; }
        .btn-mutator { background: linear-gradient(135deg, #ff0055, #ffcc00, #00ff88); color: #000; font-weight: 900; text-shadow: 0 0 3px rgba(0,0,0,0.3); }

        #main-split { display: flex; flex-direction: row; gap: 30px; align-items: flex-start; margin-top: 10px; }
        .menu-col { width: 340px; display: flex; flex-direction: column; align-items: center; }
        .user-info { margin-bottom: 20px; font-size: 16px; color: #ccc; text-align: center; width: 100%; line-height: 1.6; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .user-info span { color: #fff; font-weight: bold; font-size: 18px; }
        .lb-header-text { color: var(--accent); font-size: 14px; font-weight: bold; text-align: center; margin-bottom: 10px; margin-top: 20px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #333; padding-bottom: 5px; width: 100%; }
        .lb-list { width: 100%; font-size: 13px; } .lb-item { display: flex; justify-content: space-between; padding: 8px 5px; border-bottom: 1px solid #1a1a1a; } .rank-num { color: #ffcc00; font-weight: bold; margin-right: 5px; }
        .scroll-text { max-height: 400px; overflow-y: auto; text-align: left; font-size: 14px; color: #ccc; line-height: 1.6; padding-right: 10px; width: 100%; } .scroll-text p { margin-bottom: 15px; }

        #stats-layout { display: flex; width: 900px; height: 550px; gap: 20px; }
        #stats-list { width: 250px; background: #050505; border: 1px solid var(--accent); box-shadow: 0 0 15px var(--glow); border-radius: 4px; overflow-y: auto; padding: 10px; }
        #stats-detail { flex: 1; background: #050505; border: 1px solid var(--accent); box-shadow: 0 0 15px var(--glow); border-radius: 4px; padding: 20px; display: flex; flex-direction: column; overflow: hidden; }
        .player-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #222; color: #888; font-weight: bold; transition: 0.2s; }
        .player-item:hover { background: #111; color: #fff; } .player-item.selected { background: var(--glow); color: var(--accent); }

        .game-area { display: flex; flex-direction: row; justify-content: center; align-items: flex-start; gap: 40px; transform: scale(0.9); transition: 0.5s; }
        @media (max-height: 950px) { .game-area { transform: scale(0.75); } }
        @media only screen and (max-width: 1200px) { .game-area { transform: scale(0.65); } }
        .stats-header { display: flex; gap: 15px; margin-bottom: 10px; }
        .stat-box-top { background: #000; border: 1px solid var(--accent); box-shadow: 0 0 5px var(--glow); width: 100px; padding: 8px 0; text-align: center; transition: border-color 0.3s, box-shadow 0.3s; }
        .stat-label { font-size: 11px; color: var(--accent); font-weight: bold; letter-spacing: 1px; text-transform: uppercase; transition: color 0.3s; }
        .stat-val { font-size: 18px; font-weight: bold; color: #fff; font-family: monospace; }
        .game-columns { display: flex; align-items: flex-start; gap: 15px; }
        .col-left { display: flex; flex-direction: column; gap: 15px; width: 150px; }
        .box-container { background: #000; border: 1px solid var(--accent); box-shadow: 0 0 8px var(--glow); display: flex; flex-direction: column; align-items: center; position: relative; width: 100%; box-sizing: border-box; padding-bottom: 5px; transition: border-color 0.3s, box-shadow 0.3s; }
        .box-header { width: 100%; text-align: center; font-size: 12px; color: var(--accent); padding: 5px 0; font-weight: bold; transition: color 0.3s; }
        .box-stat-side { height: 60px; justify-content: center; padding: 0; }
        .col-center { position: relative; } .main-board-wrap { border: 2px solid var(--accent); background: #000; box-shadow: 0 0 20px var(--glow-strong); position: relative; transition: border-color 0.3s, box-shadow 0.3s; }
        .col-right { display: flex; flex-direction: column; width: 150px; }
        .side-canvas { width: 100%; display: block; }
        .garbage-container { width: 12px; height: 900px; background: #111; border: 1px solid #333; position: absolute; left: -20px; overflow: hidden; }
        .garbage-fill { position: absolute; bottom: 0; width: 100%; background: #ff0033; transition: height 0.2s; }
        #ffa-grid { display: grid; grid-template-rows: repeat(2, auto); grid-auto-flow: column; gap: 15px; }
        .mini-card { display: flex; flex-direction: column; align-items: center; background: #000; border: 1px solid #333; padding: 5px; position: relative; }
        #home-btn { position: fixed; top: 20px; left: 20px; z-index: 2000; padding: 10px 25px; background: #ff0033; color: #fff; border: none; font-weight: 900; cursor: pointer; }
        .hidden { display: none !important; }
        .overlay { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 150; display: flex; justify-content: center; align-items: center; flex-direction: column; pointer-events: none; }
        #cnt-txt { font-size: 120px; font-weight: 900; color: #fff; }
        #results-table { border-collapse: separate; border-spacing: 0 10px; margin-top: 20px; font-family: monospace; font-size: 20px; width: 700px; }
        #results-table th { color: var(--accent); padding: 15px; border-bottom: 2px solid var(--accent); text-transform: uppercase; letter-spacing: 2px; }
        #results-table td { padding: 15px; background: rgba(255,255,255,0.05); text-align: center; color: #fff; border-top: 1px solid #333; border-bottom: 1px solid #333; }
        .rank-1 { color: #ffcc00 !important; font-weight: bold; text-shadow: 0 0 10px #ffcc00; }
        #kill-feed { position: absolute; bottom: 20px; left: 20px; width: 300px; display: flex; flex-direction: column; gap: 5px; pointer-events: none; z-index: 100; }
        .feed-msg { background: rgba(255,0,0,0.2); color: #ff5555; padding: 5px; border-left: 3px solid #ff5555; font-family: monospace; }
        canvas { display: block; }

        .left-popups { display: flex; flex-direction: column; gap: 2px; min-height: 120px; }
        .float-text { font-weight: 900; opacity: 0; pointer-events: none; transition: opacity 0.3s; text-align: center; width: 100%; }
        .action-text { font-size: 20px; color: #fff; letter-spacing: 2px; } .combo-text { font-size: 16px; color: #ffcc00; } .b2b-text { font-size: 13px; color: var(--accent); } .sent-text { font-size: 28px; color: #ff0055; font-weight: 900; }

        #chat-container { position: fixed; bottom: 0; right: 0; width: 320px; z-index: 200; display: flex; flex-direction: column; }
        #chat-history { height: 200px; background: rgba(0,0,0,0.9); overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px; }
        #chat-input { padding: 10px; border: none; outline: none; }
        #chat-open-btn { position: fixed; bottom: 10px; right: 10px; z-index: 190; padding: 10px 20px; background: #000; color: var(--accent); border: 1px solid var(--accent); box-shadow: 0 0 5px var(--glow); font-weight: bold; cursor: pointer; font-family: monospace; display: none; }
        .chat-badge { position: absolute; top: -8px; right: -8px; background: #ff0033; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        #queue-banner { position: fixed; top: 0; left: 0; width: 100%; z-index: 250; background: rgba(0,0,0,0.9); border-bottom: 2px solid #ff9900; padding: 10px 0; display: none; align-items: center; justify-content: center; gap: 20px; font-family: monospace; }
        .q-mode { color: #ff9900; font-weight: 900; font-size: 16px; } .q-time { color: #888; font-size: 14px; } .q-mate { color: #ff00de; font-size: 13px; }
        .q-exit { background: #ff0033; color: #fff; border: none; padding: 8px 20px; font-weight: 900; cursor: pointer; border-radius: 4px; }

        /* Players Panel - LEFT SIDE, TALLER */
        #players-btn { position: fixed; bottom: 10px; left: 10px; z-index: 201; padding: 10px 20px; background: #000; color: #ff00de; border: 1px solid #ff00de; font-weight: 900; cursor: pointer; font-family: monospace; display: none; font-size: 13px; }
        #players-panel { position: fixed; bottom: 45px; left: 10px; z-index: 200; width: 280px; max-height: 500px; background: rgba(0,0,0,0.95); border: 1px solid #ff00de; box-shadow: 0 0 15px rgba(255,0,222,0.2); display: none; flex-direction: column; border-radius: 6px; overflow: hidden; }
        #players-panel-header { padding: 8px 10px; background: #111; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #ff00de; font-weight: bold; }
        #players-panel-close { background: #ff0033; color: white; border: none; cursor: pointer; font-weight: bold; width: 22px; height: 22px; }
        #players-list { flex: 1; overflow-y: auto; padding: 5px; max-height: 440px; }
        .player-online-item { padding: 8px 10px; cursor: pointer; border-bottom: 1px solid #1a1a1a; display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        .player-online-item:hover { background: rgba(255,0,222,0.1); }
        .player-action-btn { display: block; width: 100%; padding: 10px; margin: 4px 0; border: none; cursor: pointer; font-weight: bold; font-size: 13px; border-radius: 3px; text-transform: uppercase; }
        .status-tag { font-size: 10px; padding: 2px 6px; border-radius: 3px; font-weight: bold; }
        .status-idle { background: #333; color: #888; } .status-ffa { background: rgba(255,153,0,0.3); color: #ff9900; }
        .status-zen { background: rgba(162,155,254,0.3); color: #a29bfe; } .status-duel { background: rgba(255,0,222,0.3); color: #ff00de; }
        .status-apm_test { background: rgba(255,85,85,0.3); color: #ff5555; } .status-queuing { background: rgba(255,255,0,0.2); color: #ffff00; }
        .status-2v2 { background: rgba(0,168,255,0.3); color: #00a8ff; } .status-mutator { background: rgba(255,0,85,0.3); color: #ff0055; }

        #duel-hud { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 300; display: none; align-items: center; gap: 20px; background: rgba(0,0,0,0.85); border: 1px solid #ff00de; padding: 10px 30px; border-radius: 8px; font-family: monospace; font-weight: 900; }
        .duel-hud-name { font-size: 16px; color: #fff; min-width: 100px; text-align: center; } .duel-hud-score { font-size: 32px; color: #ff00de; min-width: 40px; text-align: center; }
        .duel-hud-vs { font-size: 14px; color: #888; } .duel-hud-round { font-size: 11px; color: #666; text-align: center; }
        #duel-results { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 400; display: none; justify-content: center; align-items: center; flex-direction: column; }
        #duel-results h1 { color: #ff00de; font-size: 48px; margin-bottom: 10px; } .duel-final-score { font-size: 64px; color: #fff; font-family: monospace; font-weight: 900; margin-bottom: 20px; } .duel-subtext { color: #888; font-size: 16px; }

        #incoming-popup { position: fixed; top: 80px; right: 20px; z-index: 300; background: rgba(0,0,0,0.95); border: 2px solid #ff00de; box-shadow: 0 0 20px rgba(255,0,222,0.4); padding: 20px; display: none; flex-direction: column; align-items: center; border-radius: 8px; min-width: 280px; }
        #incoming-popup h3 { color: #ff00de; margin-bottom: 10px; font-size: 14px; text-align: center; }
        .popup-btn { padding: 10px 30px; margin: 5px; font-weight: bold; border: none; cursor: pointer; border-radius: 4px; font-size: 14px; }
        .popup-btn-yes { background: #00ffcc; color: #000; } .popup-btn-no { background: #333; color: #fff; }

        .stat-user-title { font-size: 32px; color: var(--accent); font-weight: 900; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; }
        .stat-section-label { font-size: 12px; color: #666; margin-bottom: 8px; letter-spacing: 1px; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 4px; width: 100%; display:block; }
        .stat-row { display: flex; gap: 15px; margin-bottom: 20px; width: 100%; }
        .stat-card { flex: 1; background: #111; border: 1px solid #333; border-radius: 4px; padding: 10px; text-align: center; }
        .stat-card-val { font-size: 20px; color: #fff; font-weight: 900; font-family: monospace; } .stat-card-val.highlight { color: #ffcc00; }
        .history-wrapper { flex: 1; overflow-y: auto; border: 1px solid #222; background: #0a0a0a; border-radius: 4px; }
        .history-table { width: 100%; border-collapse: collapse; font-size: 12px; font-family: monospace; }
        .history-table th { background: #111; color: var(--accent); padding: 10px; text-align: center; position: sticky; top: 0; border-bottom: 1px solid #333; z-index: 2; }
        .history-table td { padding: 8px; border-bottom: 1px solid #222; text-align: center; color: #ccc; } .history-table tr:hover td { background: #151515; color: #fff; }
        .bug-item { padding: 12px; border-bottom: 1px solid #222; } .bug-item .bug-topic { color: var(--accent); font-weight: bold; font-size: 14px; } .bug-item .bug-meta { color: #666; font-size: 11px; margin-top: 4px; } .bug-item .bug-body { color: #ccc; font-size: 13px; margin-top: 6px; line-height: 1.4; }

        /* Mutator Class Select */
        #class-info-panel { width: 100%; min-height: 120px; background: #0a0a0a; border: 1px solid #ff0055; border-radius: 6px; padding: 20px; margin-bottom: 20px; box-sizing: border-box; }
        #class-info-panel .ci-name { font-size: 28px; font-weight: 900; color: #ffcc00; margin-bottom: 8px; }
        #class-info-panel .ci-desc { color: #888; font-style: italic; margin-bottom: 10px; font-size: 13px; }
        #class-info-panel .ci-pros { color: #00ff88; font-size: 13px; } #class-info-panel .ci-cons { color: #ff5555; font-size: 13px; margin-top: 6px; }
        .class-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; width: 100%; max-width: 700px; margin-bottom: 20px; }
        .class-card { background: #111; border: 2px solid #333; border-radius: 8px; padding: 20px 10px; text-align: center; cursor: pointer; transition: all 0.2s; font-weight: 900; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; min-height: 80px; display: flex; align-items: center; justify-content: center; }
        .class-card:hover { border-color: #ff0055; background: #1a0010; transform: translateY(-3px); }
        .class-card.selected { border-color: #ffcc00; background: #1a1500; box-shadow: 0 0 15px rgba(255,204,0,0.3); }
        .class-card.locked { opacity: 0.35; cursor: not-allowed; pointer-events: none; }
        .class-card .cc-icon { font-size: 28px; display: block; margin-bottom: 6px; }

        /* In-game class UI - flex item left of board */
        #class-hud { display: none; flex-direction: column; gap: 12px; font-family: monospace; background: rgba(0,0,0,0.85); border: 2px solid var(--accent); border-radius: 10px; padding: 20px; min-width: 200px; max-width: 220px; box-shadow: 0 0 25px var(--glow); align-self: center; }
        .class-hud-label { font-size: 14px; color: #aaa; text-transform: uppercase; letter-spacing: 2px; font-weight: 900; border-bottom: 1px solid #333; padding-bottom: 6px; margin-bottom: 4px; }
        #jackpot-ticker { font-size: 36px; color: #ffcc00; font-weight: 900; text-shadow: 0 0 15px rgba(255,204,0,0.7); text-align: center; }
        #slot-reels { display: flex; gap: 8px; font-size: 40px; font-weight: 900; justify-content: center; }
        .slot-reel { width: 60px; height: 60px; background: #111; border: 3px solid #ffcc00; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #fff; transition: all 0.3s; font-size: 36px; }
        .slot-reel.win { background: #ffcc00; color: #000; box-shadow: 0 0 20px #ffcc00; animation: slotWin 0.5s infinite alternate; }
        @keyframes slotWin { 0% { transform: scale(1); } 100% { transform: scale(1.1); } }
        #rune-sigil { display: flex; gap: 16px; justify-content: center; }
        .rune { width: 50px; height: 50px; border-radius: 50%; border: 3px solid #440000; background: #1a0000; transition: all 0.3s; }
        .rune.lit { border-color: #ff0000; background: #660000; box-shadow: 0 0 20px rgba(255,0,0,0.6); }
        .rune.ready { border-color: #ff0000; background: #ff0000; box-shadow: 0 0 30px #ff0000; animation: runePulse 0.5s infinite alternate; }
        @keyframes runePulse { 0% { box-shadow: 0 0 15px #ff0000; } 100% { box-shadow: 0 0 40px #ff0000, 0 0 60px rgba(255,0,0,0.3); } }
        #cultist-cd-bar { width: 100%; height: 8px; background: #220000; border-radius: 4px; margin-top: 8px; overflow: hidden; }
        #cultist-cd-fill { width: 0%; height: 100%; background: #ff0000; border-radius: 4px; transition: width 0.1s linear; }
        #magazine { display: flex; flex-direction: column-reverse; gap: 3px; align-items: center; }
        .bullet-slot { width: 36px; height: 16px; border: 2px solid #555; background: #111; transition: all 0.2s; border-radius: 2px; }
        .bullet-slot.loaded { background: #ffcc00; border-color: #ffcc00; box-shadow: 0 0 8px rgba(255,204,0,0.5); }
        .sniper-crosshair { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 2px solid rgba(255,0,0,0.6); border-radius: 50%; pointer-events: none; z-index: 10; display: none; box-shadow: inset 0 0 20px rgba(255,0,0,0.2); }
        .sniper-crosshair::before, .sniper-crosshair::after { content: ''; position: absolute; background: rgba(255,0,0,0.4); }
        .sniper-crosshair::before { width: 100%; height: 2px; top: 50%; } .sniper-crosshair::after { height: 100%; width: 2px; left: 50%; }

        /* Admin Panel */
        #admin-panel { position: fixed; top: 50px; left: 10px; z-index: 2000; background: rgba(0,0,0,0.95); border: 2px solid #ffcc00; box-shadow: 0 0 20px rgba(255,204,0,0.3); border-radius: 8px; width: 280px; display: none; flex-direction: column; font-family: monospace; font-size: 12px; max-height: 500px; overflow-y: auto; }
        #admin-panel-header { background: #1a1500; padding: 8px 12px; border-bottom: 1px solid #ffcc00; color: #ffcc00; font-weight: 900; display: flex; justify-content: space-between; align-items: center; }
        .admin-section { padding: 10px; border-bottom: 1px solid #333; }
        .admin-section-title { color: #ffcc00; font-weight: bold; margin-bottom: 6px; font-size: 11px; text-transform: uppercase; }
        .admin-btn { width: 100%; padding: 8px; margin: 3px 0; border: 1px solid #555; background: #111; color: #fff; cursor: pointer; font-weight: bold; font-size: 11px; border-radius: 3px; text-transform: uppercase; }
        .admin-btn:hover { background: #222; border-color: #ffcc00; }
        .admin-btn.danger { border-color: #ff0033; color: #ff0033; }
        .admin-btn.danger:hover { background: #1a0005; }
        .admin-player-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid #1a1a1a; }
        .admin-player-row span { color: #ccc; font-size: 11px; }
        #admin-toggle { position: fixed; top: 50px; left: 10px; z-index: 1999; padding: 6px 12px; background: #000; color: #ffcc00; border: 1px solid #ffcc00; font-weight: 900; cursor: pointer; font-family: monospace; font-size: 11px; display: none; border-radius: 4px; }
    </style>
</head>
<body>
    <button id="home-btn" class="hidden" onclick="goHome()">HOME</button>
    <div id="queue-banner"><span class="q-mode" id="q-mode-text">SEARCHING...</span><span class="q-mate" id="q-mate-text"></span><span class="q-time" id="q-time-text">0:00</span><button class="q-exit" onclick="leaveQueue()">LEAVE QUEUE</button></div>

    <div id="menu-container">
        <div id="scr-login" class="screen active" style="width:auto;">
            <h1>PROJECT <span>A</span></h1><p style="color:#888; margin-bottom:10px;">STUDENT LOGIN</p>
            <input type="text" id="username" class="input-std" placeholder="USERNAME" maxlength="12" oninput="saveCreds()">
            <input type="password" id="password" class="input-std" placeholder="PASSWORD" oninput="saveCreds()">
            <button class="btn btn-green" onclick="attemptLogin()">LOGIN / REGISTER</button>
        </div>
        <div id="scr-main" class="screen">
            <h1>PROJECT <span>A</span></h1>
            <div id="main-split">
                <div class="menu-col tech-panel">
                    <div class="lb-header-text">ABOUT PROJECT A</div>
                    <div class="scroll-text">
                        <p>Project A is working to releasing its 1.0 update. As of right now all account data will be wiped every update.</p>
                        <p>Project A's development has taken roughly 20 or so hours to get this far and I am paying $7 monthly for the server. If you would like to support development or want to see the servers upgraded money is greatly appreciated.</p>
                        <div class="lb-header-text" style="margin-top:25px;margin-bottom:10px;">CUSTOM USERNAME EFFECTS</div>
                        <p>If you would like to have a custom username effect pay me $5.</p>
                        <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:15px;text-align:center;font-size:1.3em;">
                            <span class="user-john">John</span><span class="user-glitch">Jeffrey</span><span class="user-inferno">Jeremy</span><span class="user-diamond">Timmy</span><span class="user-gamer">Darel</span><span class="user-synth">Josh</span><span class="user-midas">Calvin</span><span class="user-sparkle">Starlight</span>
                        </div>
                    </div>
                    <button class="btn btn-pink" style="margin-top:20px;" onclick="navTo('scr-changelog')">CHANGELOG</button>
                </div>
                <div class="menu-col tech-panel">
                    <div class="user-info">Welcome, <span id="display-user">Guest</span><br>Your Wins: <span id="display-wins">0</span><br>Best APM: <span id="display-apm">0</span></div>
                    <button class="btn btn-multi" onclick="navTo('scr-multi')">MULTIPLAYER</button>
                    <button class="btn btn-sp" onclick="navTo('scr-sp')">SINGLE PLAYER</button>
                    <button class="btn btn-bug" onclick="openBugs()">BUGS / SUGGESTIONS</button>
                    <button class="btn btn-blue" onclick="openStats()">STATS / HISTORY</button>
                    <button class="btn" style="background:#222;color:#888;margin-top:20px;" onclick="logOut()">LOGOUT</button>
                </div>
                <div class="menu-col tech-panel">
                    <div class="lb-header-text">ONLINE WIN LEADERBOARD</div><div id="lb-wins" class="lb-list"><div style="text-align:center;color:#666;">Loading...</div></div>
                    <div class="lb-header-text">HIGHEST COMBO</div><div id="lb-combo" class="lb-list"><div style="text-align:center;color:#666;">Loading...</div></div>
                </div>
            </div>
        </div>
        <div id="scr-multi" class="screen" style="width:auto;">
            <h1 style="font-size:40px;">MULTI<span>PLAYER</span></h1>
            <button class="btn btn-ffa" onclick="joinFFA()">ONLINE FFA</button>
            <button class="btn btn-pink" onclick="joinQueue('duel')">1v1 DUEL</button>
            <button class="btn btn-blue" onclick="open2v2Invite()">2v2 TEAM</button>
            <button class="btn btn-mutator" onclick="navTo('scr-class-select')">MUTATOR MADNESS</button>
            <button class="btn" style="background:#222;color:#fff;border:1px solid #444;margin-top:20px;" onclick="navTo('scr-main')">BACK</button>
        </div>
        <div id="scr-sp" class="screen" style="width:auto;">
            <h1 style="font-size:40px;">SINGLE <span>PLAYER</span></h1>
            <button class="btn btn-zen" onclick="startZen()">ZEN MODE</button>
            <button class="btn btn-apm" onclick="startAPMTest()">APM TEST</button>
            <button class="btn" style="background:#222;color:#fff;border:1px solid #444;margin-top:20px;" onclick="navTo('scr-main')">BACK</button>
        </div>
        <div id="scr-changelog" class="screen">
            <h2 style="color:#ff00de;margin-bottom:10px;">CHANGELOG</h2>
            <div style="width:600px;height:300px;background:#050505;border:1px solid #ff00de;border-radius:4px;padding:20px;display:flex;align-items:center;justify-content:center;"><span style="color:#888;font-size:18px;">nothing to see here.</span></div>
            <button class="btn" onclick="navTo('scr-main')" style="margin-top:20px;background:#222;color:#fff;border:1px solid #444;">BACK TO MENU</button>
        </div>
        <div id="scr-bugs" class="screen">
            <h2 style="color:var(--accent);margin-bottom:10px;">BUGS / SUGGESTIONS</h2>
            <div style="display:flex;width:900px;height:550px;gap:20px;">
                <div style="flex:1;background:#050505;border:1px solid var(--accent);border-radius:4px;overflow-y:auto;padding:10px;" id="bugs-list-container"><div style="text-align:center;color:#666;padding:40px;">No reports yet.</div></div>
                <div style="width:350px;display:flex;flex-direction:column;gap:10px;">
                    <div class="lb-header-text" style="margin:0;">NEW REPORT</div>
                    <input type="text" id="bug-topic" class="input-std" placeholder="TOPIC" maxlength="50" style="width:100%;box-sizing:border-box;">
                    <textarea id="bug-body" style="background:#111;border:1px solid #333;color:#fff;padding:12px;font-size:14px;border-radius:4px;width:100%;box-sizing:border-box;height:200px;resize:none;" placeholder="Describe the bug or suggestion..."></textarea>
                    <button class="btn btn-green" style="width:100%;" onclick="submitBug()">SUBMIT</button>
                </div>
            </div>
            <button class="btn" onclick="navTo('scr-main')" style="margin-top:20px;background:#222;color:#fff;border:1px solid #444;">BACK TO MENU</button>
        </div>
        <div id="scr-stats" class="screen">
            <h2 style="color:var(--accent);margin-bottom:10px;">PLAYER STATISTICS</h2>
            <div style="display:flex;gap:10px;margin-bottom:10px;">
                <button class="btn" id="stats-tab-general" onclick="switchStatsTab('general')" style="background:var(--accent);color:#000;width:auto;padding:10px 20px;">GENERAL</button>
                <button class="btn" id="stats-tab-duels" onclick="switchStatsTab('duels')" style="background:#222;color:#888;width:auto;padding:10px 20px;">DUEL HISTORY</button>
            </div>
            <div id="stats-layout"><div id="stats-list"></div><div id="stats-detail"><div style="text-align:center;color:#666;margin-top:100px;font-size:18px;">Select a player.</div></div></div>
            <div id="stats-duel-layout" style="display:none;width:900px;height:550px;"><div id="stats-duel-content" style="width:100%;height:100%;background:#050505;border:1px solid var(--accent);border-radius:4px;padding:20px;overflow-y:auto;"></div></div>
            <button class="btn" onclick="navTo('scr-main')" style="margin-top:20px;background:#222;color:#fff;border:1px solid #444;">BACK TO MENU</button>
        </div>
        <div id="scr-2v2-pick" class="screen" style="width:auto;">
            <h2 style="color:#00a8ff;margin-bottom:10px;" id="pick-title">SELECT YOUR TEAMMATE</h2>
            <div style="width:320px;max-height:400px;background:#050505;border:1px solid #00a8ff;border-radius:4px;overflow-y:auto;padding:10px;" id="pick-list"></div>
            <button class="btn" onclick="navTo('scr-multi')" style="margin-top:20px;background:#222;color:#fff;border:1px solid #444;">CANCEL</button>
        </div>
        <!-- CLASS SELECT -->
        <div id="scr-class-select" class="screen">
            <h2 style="color:#ff0055;margin-bottom:10px;font-size:28px;text-transform:uppercase;letter-spacing:3px;">MUTATOR MADNESS</h2>
            <div id="class-info-panel">
                <div class="ci-name" id="ci-name">Select a Class</div>
                <div class="ci-desc" id="ci-desc">Choose your playstyle below.</div>
                <div class="ci-pros" id="ci-pros"></div>
                <div class="ci-cons" id="ci-cons"></div>
            </div>
            <div class="class-grid" id="class-grid"></div>
            <button class="btn btn-mutator" id="class-confirm-btn" onclick="confirmClass()" style="width:400px;">CONFIRM & QUEUE</button>
            <button class="btn" onclick="navTo('scr-multi')" style="margin-top:10px;background:#222;color:#fff;border:1px solid #444;width:400px;">BACK</button>
        </div>
    </div>

    <div id="overlay-cnt" class="overlay hidden"><div id="cnt-txt">3</div></div>
    <div id="overlay-results" class="overlay hidden">
        <h1 style="color:var(--accent);">RESULTS</h1>
        <table id="results-table"><thead><tr><th>#</th><th>PLAYER</th><th>SURVIVED</th><th>APM</th><th>PPS</th><th>SENT</th><th>RECV</th></tr></thead><tbody id="results-body"></tbody></table>
        <div style="margin-top:20px;font-size:16px;color:#888;">Next round in <span id="res-timer">5</span>s...</div>
    </div>
    <div id="kill-feed"></div>

    <button id="chat-open-btn" onclick="toggleChat()">CHAT<span id="chat-badge" class="chat-badge hidden">0</span></button>
    <div id="chat-container" class="hidden"><div id="chat-header" style="background:#222;padding:5px;display:flex;justify-content:flex-end;"><button onclick="toggleChat()">X</button></div><div id="chat-history"></div><input type="text" id="chat-input" placeholder="Chat here..." onkeydown="sendChat(event)"></div>

    <button id="players-btn" onclick="togglePlayers()">PLAYERS</button>
    <div id="players-panel"><div id="players-panel-header"><span>ONLINE PLAYERS</span><button id="players-panel-close" onclick="togglePlayers()">X</button></div><div id="players-list"></div></div>
    <div id="incoming-popup"><h3 id="incoming-popup-text">INVITE</h3><div id="incoming-popup-btns"></div></div>
    <div id="duel-hud"><div><div class="duel-hud-name" id="duel-hud-p1">P1</div></div><div class="duel-hud-score" id="duel-hud-s1">0</div><div><div class="duel-hud-vs">VS</div><div class="duel-hud-round" id="duel-hud-round">ROUND 1</div></div><div class="duel-hud-score" id="duel-hud-s2">0</div><div><div class="duel-hud-name" id="duel-hud-p2">P2</div></div></div>
    <div id="duel-results"><h1 id="duel-results-title">DUEL OVER</h1><div class="duel-final-score" id="duel-results-score">0 - 0</div><div class="duel-subtext" id="duel-results-sub">Returning to menu...</div></div>

    <!-- ADMIN PANEL (John only) -->
    <button id="admin-toggle" onclick="toggleAdmin()">⚙ ADMIN</button>
    <div id="admin-panel">
        <div id="admin-panel-header"><span>⚙ ADMIN PANEL</span><button style="background:none;border:none;color:#ffcc00;cursor:pointer;font-weight:900;" onclick="toggleAdmin()">X</button></div>
        <div class="admin-section">
            <div class="admin-section-title">Server Controls</div>
            <button class="admin-btn danger" onclick="adminRestartFFA()">Restart FFA Lobby</button>
            <button class="admin-btn danger" onclick="adminRestartMutator()">Restart Mutator Lobby</button>
            <button class="admin-btn danger" onclick="adminRestartServer()">Restart Server</button>
        </div>
        <div class="admin-section">
            <div class="admin-section-title">Players Online</div>
            <div id="admin-player-list"></div>
        </div>
    </div>

    <div id="game-ui" class="game-area hidden">
        <div id="class-hud">
            <div id="hud-highroller" style="display:none;"><div class="class-hud-label">JACKPOT</div><div id="jackpot-ticker">Luck: 0.1%</div><div id="slot-reels"><div class="slot-reel" id="sr0">-</div><div class="slot-reel" id="sr1">-</div><div class="slot-reel" id="sr2">-</div></div></div>
            <div id="hud-cultist" style="display:none;"><div class="class-hud-label">RUNES (Z to Sacrifice)</div><div id="rune-sigil"><div class="rune" id="rune0"></div><div class="rune" id="rune1"></div><div class="rune" id="rune2"></div></div><div id="cultist-cd-bar"><div id="cultist-cd-fill"></div></div><div id="cultist-cd-text" style="text-align:center;font-size:12px;color:#660000;margin-top:4px;">READY</div></div>
            <div id="hud-sniper" style="display:none;"><div class="class-hud-label">MAGAZINE</div><div id="magazine"></div><div class="class-hud-label" style="margin-top:10px;">TARGET</div><div id="sniper-target-name" style="color:#ff0055;font-weight:900;font-size:20px;text-align:center;">---</div></div>
        </div>
        <div id="p1-root" class="player-root">
            <div class="stats-header">
                <div class="stat-box-top"><div class="stat-label">TIME</div><div id="s-time" class="stat-val">00:00</div></div>
                <div class="stat-box-top"><div class="stat-label">PPS</div><div id="s-pps" class="stat-val">0.00</div></div>
                <div class="stat-box-top"><div class="stat-label">APM</div><div id="s-apm" class="stat-val">0</div></div>
            </div>
            <div class="game-columns">
                <div class="col-left">
                    <div class="box-container"><div class="box-header">HOLD</div><canvas id="p1-h" class="side-canvas" width="150" height="160"></canvas></div>
                    <div class="box-container box-stat-side"><div class="box-header">SENT</div><div id="s-sent" class="stat-val" style="margin-bottom:5px;">0</div></div>
                    <div class="box-container box-stat-side"><div class="box-header">RECV</div><div id="s-recv" class="stat-val" style="margin-bottom:5px;">0</div></div>
                    <div class="left-popups"><div id="pop-action" class="float-text action-text"></div><div id="pop-combo" class="float-text combo-text"></div><div id="pop-b2b" class="float-text b2b-text"></div><div id="pop-sent" class="float-text sent-text"></div></div>
                </div>
                <div class="col-center"><div class="garbage-container"><div id="p1-g" class="garbage-fill"></div></div><div class="main-board-wrap"><canvas id="p1" width="120" height="900"></canvas></div></div>
                <div class="col-right"><div class="box-container"><div class="box-header">NEXT</div><canvas id="p1-n" class="side-canvas" width="150" height="400"></canvas></div></div>
            </div>
        </div>
        <div id="ffa-grid"></div>
    </div>
<script>
const COLS=4,ROWS=30,B_SIZE=30;
const PIECES=[[[1,1,1,1]],[[1,1],[1,1]],[[0,1,0],[1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]]];
const COLORS=['#31C7EF','#F7D308','#FF69B4','#EF2029','#42B642','#9D00FF','#EF7921'];
const OFFSETS_JLSTZ=[[[0,0],[0,0],[0,0],[0,0],[0,0]],[[0,0],[1,0],[1,-1],[0,2],[1,2]],[[0,0],[0,0],[0,0],[0,0],[0,0]],[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],[[0,0],[0,0],[0,0],[0,0],[0,0]],[[0,0],[1,0],[1,1],[0,-2],[1,-2]],[[0,0],[0,0],[0,0],[0,0],[0,0]],[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]]];
const OFFSETS_I=[[[0,0],[-1,0],[2,0],[-1,0],[2,0]],[[0,-1],[0,-1],[0,-1],[0,1],[0,-2]],[[-1,0],[0,0],[0,0],[0,1],[0,-2]],[[0,1],[0,1],[0,1],[0,-1],[0,2]],[[-1,1],[2,1],[-1,1],[2,0],[-1,0]],[[0,1],[0,1],[0,1],[0,-1],[0,2]],[[0,1],[0,1],[0,1],[0,-1],[0,2]],[[0,-1],[0,-1],[0,-1],[0,1],[0,-2]]];
const KICK_INDEX={"0_1":0,"1_0":1,"1_2":2,"2_1":3,"2_3":4,"3_2":5,"3_0":6,"0_3":7};

// === CLASS DATA ===
const CLASS_DATA = {
    high_roller: { name:'HIGH ROLLER', icon:'\u{1F3B0}', desc:'Gamble your way to victory with progressive jackpot mechanics.',
        pros:['Every line clear rolls for a 20-line jackpot','Jackpot odds increase every clear','Floor raises after each win'],
        cons:['Normal garbage output reduced by 50%','RNG dependent - might never hit','Early game is very weak'] },
    cultist: { name:'CULTIST', icon:'\u{1F480}', desc:'Sacrifice your own board to unleash devastating exorcisms.',
        pros:['Exorcism clears ALL garbage and sends it 1.5x multiplied','Burst damage potential is massive','Self-harm grants strategic control'],
        cons:['Must take 18 lines of self-damage to charge (6 per rune)','Receives 1.5x MORE garbage from enemies','Sacrifice has 15 second cooldown'] },
    combo_sniper: { name:'COMBO SNIPER', icon:'\u{1F3AF}', desc:'Store ammunition from clears and unleash it all in one devastating triple or quad.',
        pros:['Max 19 lines of targeted damage in one shot','Always targets the player doing best','Line clears cancel incoming garbage','Fires on triples AND quads'],
        cons:['Cancelled garbage is NOT sent to enemies','Must clear triples/quads to deal damage','Lose bullets on death (transferred to killer)'] },
    locked1:{name:'COMING SOON',icon:'\u{1F512}',desc:'',pros:[],cons:[]},
    locked2:{name:'COMING SOON',icon:'\u{1F512}',desc:'',pros:[],cons:[]},
    locked3:{name:'COMING SOON',icon:'\u{1F512}',desc:'',pros:[],cons:[]},
    locked4:{name:'COMING SOON',icon:'\u{1F512}',desc:'',pros:[],cons:[]},
    locked5:{name:'COMING SOON',icon:'\u{1F512}',desc:'',pros:[],cons:[]}
};

let socket=null,gameActive=false,inputLocked=false,isSpectator=false,gameMode='zen',apmTimer=null,statsCache={};
let isChatOpen=false,unreadChatCount=0,isPlayersOpen=false,onlinePlayersList=[];
let currentDuel=null,current2v2=null,queueMode=null,queueStartTime=0,queueTimerInterval=null,queueTeammate=null;
let pendingInviteType=null,pendingInviteId=null;
// Mutator state
let selectedClass=null,activeClass=null;
let hrJackpotChance=0.001,hrFloor=0.001,hrFloorStep=0;
let cultRunes=0,cultExorcismReady=false;
let sniperBullets=0,sniperTargetId=null,sniperTargetName='---';
let cultSacrificeCooldown=false;

function formatUserHTML(u){if(!u)return'Guest';const n=u.trim();if(n==='John')return'<span class="user-john">John</span>';if(n==='La Bamba\u{1F0CF}')return'<span class="user-bamba">La Bamba\u{1F0CF}</span>';return u;}
function setTheme(h){const r=document.documentElement;r.style.setProperty('--accent',h);const rv=parseInt(h.slice(1,3),16),g=parseInt(h.slice(3,5),16),b=parseInt(h.slice(5,7),16);r.style.setProperty('--glow',`rgba(${rv},${g},${b},0.2)`);r.style.setProperty('--glow-strong',`rgba(${rv},${g},${b},0.4)`);}
function sysMsg(t){const b=document.getElementById('chat-history');if(b){b.innerHTML+=`<div><span style="color:#ff00de;font-weight:bold;">[SYSTEM]:</span> ${t}</div>`;b.scrollTop=b.scrollHeight;}}
window.onload=function(){if(localStorage.getItem('savedUser')){document.getElementById('username').value=localStorage.getItem('savedUser');if(localStorage.getItem('savedPass'))document.getElementById('password').value=localStorage.getItem('savedPass');attemptLogin();}initClassGrid();};
function saveCreds(){localStorage.setItem('savedUser',document.getElementById('username').value);localStorage.setItem('savedPass',document.getElementById('password').value);}
function navTo(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}
function logOut(){localStorage.clear();location.reload();}

function initClassGrid(){
    const grid=document.getElementById('class-grid'); grid.innerHTML='';
    const keys=['high_roller','cultist','combo_sniper','locked1','locked2','locked3','locked4','locked5'];
    keys.forEach(k=>{const d=CLASS_DATA[k];const c=document.createElement('div');c.className='class-card'+(k.startsWith('locked')?' locked':'');
        c.innerHTML=`<div><span class="cc-icon">${d.icon}</span>${d.name}</div>`;
        if(!k.startsWith('locked')){c.onclick=()=>{document.querySelectorAll('.class-card').forEach(x=>x.classList.remove('selected'));c.classList.add('selected');selectedClass=k;showClassInfo(k);};}
        grid.appendChild(c);
    });
}
function showClassInfo(k){
    const d=CLASS_DATA[k];
    document.getElementById('ci-name').innerText=d.name;
    document.getElementById('ci-desc').innerText=d.desc;
    document.getElementById('ci-pros').innerHTML=d.pros.map(p=>'<div style="margin:2px 0;">\u2713 '+p+'</div>').join('');
    document.getElementById('ci-cons').innerHTML=d.cons.map(c=>'<div style="margin:2px 0;">\u2717 '+c+'</div>').join('');
}
function confirmClass(){if(!selectedClass)return alert('Select a class first.');if(!socket)connect();socket.emit('join_mutator_queue',{className:selectedClass});gameMode='mutator';setTheme('#ff0055');setupGameUI();document.getElementById('ffa-grid').innerHTML='';document.getElementById('overlay-cnt').classList.remove('hidden');document.getElementById('cnt-txt').innerText='Waiting for players...';inputLocked=true;}

function toggleChat(){const c=document.getElementById('chat-container'),b=document.getElementById('chat-open-btn'),bg=document.getElementById('chat-badge');if(c.classList.contains('hidden')){c.classList.remove('hidden');b.style.display='none';isChatOpen=true;unreadChatCount=0;bg.innerText='0';bg.classList.add('hidden');}else{c.classList.add('hidden');b.style.display='block';isChatOpen=false;}}
function togglePlayers(){const p=document.getElementById('players-panel');if(isPlayersOpen){p.style.display='none';isPlayersOpen=false;}else{p.style.display='flex';isPlayersOpen=true;refreshPlayerList();}}
function refreshPlayerList(){
    const ld=document.getElementById('players-list');ld.innerHTML='';
    const myName=(document.getElementById('username')||{}).value||'';
    onlinePlayersList.forEach(p=>{if(p.username===myName.trim())return;const item=document.createElement('div');item.className='player-online-item';
        let sc='status-idle',st='IDLE';
        if(p.status==='ffa'){sc='status-ffa';st='FFA';}else if(p.status==='zen'){sc='status-zen';st='ZEN';}
        else if(p.status==='duel'){sc='status-duel';st='DUEL';}else if(p.status==='queuing'){sc='status-queuing';st='QUEUE';}
        else if(p.status==='2v2'){sc='status-2v2';st='2v2';}else if(p.status==='mutator'){sc='status-mutator';st='MM';}
        item.innerHTML=`<span>${formatUserHTML(p.username)}</span><span class="status-tag ${sc}">${st}</span>`;
        item.onclick=()=>showPlayerActions(p);ld.appendChild(item);
    });
    if(!ld.children.length)ld.innerHTML='<div style="text-align:center;color:#666;padding:20px;">No other players online</div>';
}
function showPlayerActions(p){
    const ld=document.getElementById('players-list');
    ld.innerHTML=`<div style="padding:15px;text-align:center;"><div style="font-size:16px;margin-bottom:15px;">${formatUserHTML(p.username)}</div>
    <button class="player-action-btn" style="background:#ff00de;color:#fff;" onclick="sendDuelChallenge('${p.id}')">1v1 DUEL</button>
    <button class="player-action-btn" style="background:#00a8ff;color:#fff;" onclick="sendTeamInvite('${p.id}')">2v2 TEAMMATE</button>
    <button class="player-action-btn" style="background:#333;color:#fff;margin-top:10px;" onclick="refreshPlayerList()">BACK</button></div>`;
}
function sendDuelChallenge(tid){if(socket)socket.emit('duel_challenge',tid);togglePlayers();}
function sendTeamInvite(tid){if(socket)socket.emit('team_invite',tid);togglePlayers();}

function joinFFA(){if(!socket)connect();socket.emit('join_ffa');gameMode='ffa';setTheme('#ff9900');setupGameUI();document.getElementById('ffa-grid').innerHTML='';document.getElementById('overlay-cnt').classList.remove('hidden');document.getElementById('cnt-txt').innerText='Waiting for players...';inputLocked=true;}
function joinQueue(mode){if(!socket)connect();if(queueMode){alert('Already in queue!');return;}socket.emit('join_queue',mode);}
function leaveQueue(){if(socket)socket.emit('leave_queue');clearQueueUI();}
function clearQueueUI(){queueMode=null;queueTeammate=null;clearInterval(queueTimerInterval);document.getElementById('queue-banner').style.display='none';}
function showQueueBanner(mode,mate){queueMode=mode;queueStartTime=Date.now();queueTeammate=mate||null;document.getElementById('q-mode-text').innerText='SEARCHING: '+mode.toUpperCase();document.getElementById('q-mate-text').innerText=mate?('Teammate: '+mate):'';document.getElementById('q-time-text').innerText='0:00';document.getElementById('queue-banner').style.display='flex';clearInterval(queueTimerInterval);queueTimerInterval=setInterval(()=>{const s=Math.floor((Date.now()-queueStartTime)/1000);document.getElementById('q-time-text').innerText=Math.floor(s/60)+':'+String(s%60).padStart(2,'0');},1000);}
function open2v2Invite(){navTo('scr-2v2-pick');const list=document.getElementById('pick-list');list.innerHTML='';const myName=(document.getElementById('username')||{}).value||'';onlinePlayersList.forEach(p=>{if(p.username===myName.trim()||p.status==='duel'||p.status==='2v2')return;const item=document.createElement('div');item.className='player-online-item';item.innerHTML=`<span>${formatUserHTML(p.username)}</span>`;item.onclick=()=>{if(socket)socket.emit('team_invite',p.id);navTo('scr-multi');};list.appendChild(item);});if(!list.children.length)list.innerHTML='<div style="text-align:center;color:#666;padding:20px;">No available players</div>';}
function showIncoming(type,fromId,fromName){pendingInviteType=type;pendingInviteId=fromId;const pop=document.getElementById('incoming-popup'),txt=document.getElementById('incoming-popup-text'),btns=document.getElementById('incoming-popup-btns');if(type==='team')txt.innerHTML=formatUserHTML(fromName)+' wants you as a 2v2 TEAMMATE';else if(type==='duel')txt.innerHTML=formatUserHTML(fromName)+' challenges you to a DUEL!';btns.innerHTML='<button class="popup-btn popup-btn-yes" onclick="acceptIncoming()">ACCEPT</button><button class="popup-btn popup-btn-no" onclick="declineIncoming()">DECLINE</button>';pop.style.display='flex';}
function acceptIncoming(){if(pendingInviteType==='team'&&socket)socket.emit('team_invite_accept',pendingInviteId);else if(pendingInviteType==='duel'&&socket)socket.emit('duel_accept',pendingInviteId);document.getElementById('incoming-popup').style.display='none';pendingInviteType=null;pendingInviteId=null;}
function declineIncoming(){if(pendingInviteType==='team'&&socket)socket.emit('team_invite_decline',pendingInviteId);else if(pendingInviteType==='duel'&&socket)socket.emit('duel_decline',pendingInviteId);document.getElementById('incoming-popup').style.display='none';pendingInviteType=null;pendingInviteId=null;}

function attemptLogin(){const u=document.getElementById('username').value.trim(),p=document.getElementById('password').value.trim();if(!u||!p)return alert("Enter Username and Password.");if(!socket)connect();socket.emit('login_attempt',{username:u,password:p});}
function goHome(){
    gameActive=false;gameMode='menu';isSpectator=false;currentDuel=null;current2v2=null;activeClass=null;clearTimeout(apmTimer);
    if(socket){socket.emit('go_home');socket.emit('set_status','idle');}
    document.getElementById('game-ui').classList.add('hidden');document.getElementById('home-btn').classList.add('hidden');
    document.getElementById('kill-feed').innerHTML='';document.getElementById('ffa-grid').innerHTML='';
    document.querySelectorAll('.overlay').forEach(el=>el.classList.add('hidden'));
    document.getElementById('menu-container').style.display='flex';document.getElementById('duel-results').style.display='none';
    document.getElementById('duel-hud').style.display='none';document.getElementById('incoming-popup').style.display='none';
    document.getElementById('class-hud').style.display='none';
    hideAllClassHuds();setTheme('#00ffcc');navTo('scr-main');
}
function hideAllClassHuds(){['hud-highroller','hud-cultist','hud-sniper'].forEach(id=>{const el=document.getElementById(id);if(el)el.style.display='none';});}
function openStats(){if(!socket)return alert("Login first.");socket.emit('request_all_stats');navTo('scr-stats');}
function openBugs(){if(!socket)return alert("Login first.");socket.emit('request_bugs');navTo('scr-bugs');}
function submitBug(){const t=document.getElementById('bug-topic').value.trim(),b=document.getElementById('bug-body').value.trim();if(!t||!b)return alert('Fill in both fields.');if(socket)socket.emit('submit_bug',{topic:t,body:b});document.getElementById('bug-topic').value='';document.getElementById('bug-body').value='';}
function startZen(){if(socket)socket.emit('set_status','zen');gameMode='zen';isSpectator=false;setTheme('#a29bfe');setupGameUI();document.getElementById('ffa-grid').innerHTML='';p1.initRNG(Math.random()*999);p1.reset();gameActive=true;loop();}
function startAPMTest(){if(socket)socket.emit('set_status','apm_test');gameMode='apm_test';isSpectator=false;setTheme('#ff5555');clearTimeout(apmTimer);setupGameUI();document.getElementById('ffa-grid').innerHTML='';p1.initRNG(Math.random()*999);p1.reset();gameActive=true;loop();apmTimer=setTimeout(()=>{gameActive=false;document.getElementById('overlay-cnt').classList.remove('hidden');document.getElementById('cnt-txt').innerText=p1.elAPM.innerText+" APM";setTimeout(goHome,3000);},60000);}
function setupGameUI(){document.getElementById('menu-container').style.display='none';document.getElementById('game-ui').classList.remove('hidden');document.getElementById('home-btn').classList.remove('hidden');}
function startDuelGame(seed){gameMode='duel';isSpectator=false;setTheme('#ff00de');setupGameUI();document.getElementById('ffa-grid').innerHTML='';p1.initRNG(seed);p1.reset();gameActive=true;loop();}
function start2v2Game(seed){gameMode='2v2';isSpectator=false;setTheme('#00a8ff');setupGameUI();document.getElementById('ffa-grid').innerHTML='';p1.initRNG(seed);p1.reset();gameActive=true;loop();}
function startMutatorGame(seed,className){
    gameMode='mutator';activeClass=className;isSpectator=false;setTheme('#ff0055');setupGameUI();document.getElementById('ffa-grid').innerHTML='';
    p1.initRNG(seed);p1.reset();gameActive=true;
    // Reset class state
    hrJackpotChance=0.001;hrFloorStep=0;hrFloor=0.001;
    cultRunes=0;cultExorcismReady=false;cultSacrificeCooldown=false;
    sniperBullets=0;sniperTargetId=null;sniperTargetName='---';
    // Init magazine bullets
    const mag=document.getElementById('magazine');mag.innerHTML='';for(let i=0;i<10;i++){const s=document.createElement('div');s.className='bullet-slot';s.id='bullet'+i;mag.appendChild(s);}
    // Show correct HUD
    document.getElementById('class-hud').style.display='flex';hideAllClassHuds();
    if(className==='high_roller'){document.getElementById('hud-highroller').style.display='block';updateJackpotUI();}
    else if(className==='cultist'){document.getElementById('hud-cultist').style.display='block';updateRuneUI();document.getElementById('cultist-cd-fill').style.width='0%';}
    else if(className==='combo_sniper'){document.getElementById('hud-sniper').style.display='block';updateMagazineUI();}
    loop();
}

// === CLASS MECHANICS ===
function updateJackpotUI(){document.getElementById('jackpot-ticker').innerText='Luck: '+(hrJackpotChance*100).toFixed(1)+'%';}
function spinSlots(won){
    const symbols=['7','\u2605','\u2666','X','$','!'];const reels=[document.getElementById('sr0'),document.getElementById('sr1'),document.getElementById('sr2')];
    if(won){reels.forEach(r=>{r.innerText='7';r.classList.add('win');});setTimeout(()=>reels.forEach(r=>r.classList.remove('win')),3000);}
    else{reels.forEach(r=>{r.innerText=symbols[Math.floor(Math.random()*symbols.length)];r.classList.remove('win');});}
}
function updateRuneUI(){
    for(let i=0;i<3;i++){const r=document.getElementById('rune'+i);r.className='rune';if(i<cultRunes){if(cultRunes>=3)r.classList.add('ready');else r.classList.add('lit');}}
    cultExorcismReady=(cultRunes>=3);
}
function updateMagazineUI(){for(let i=0;i<10;i++){const el=document.getElementById('bullet'+i);if(el){el.className='bullet-slot';if(i<sniperBullets)el.classList.add('loaded');}}}
function updateSniperCrosshair(){
    document.querySelectorAll('.sniper-crosshair').forEach(el=>el.remove());
    if(sniperTargetId){const cvs=document.getElementById('cvs_'+sniperTargetId);if(cvs&&cvs.parentElement){let ch=cvs.parentElement.querySelector('.sniper-crosshair');if(!ch){ch=document.createElement('div');ch.className='sniper-crosshair';cvs.parentElement.style.position='relative';cvs.parentElement.appendChild(ch);}ch.style.display='block';}}
}

function cultistSacrifice(){
    if(!gameActive||isSpectator||activeClass!=='cultist'||cultRunes>=3||cultSacrificeCooldown)return;
    for(let i=0;i<6;i++){const r=Array(COLS).fill('#555');r[Math.floor(Math.random()*COLS)]=0;p1.grid.shift();p1.grid.push(r);}
    p1.linesRecvTotal+=6;p1.gBar.style.height=(p1.pendingG*B_SIZE)+'px';p1.updateStats();
    cultRunes++;updateRuneUI();
    if(cultRunes>=3)sysMsg('EXORCISM READY! Clear any line to unleash!');
    cultSacrificeCooldown=true;
    const cdFill=document.getElementById('cultist-cd-fill');const cdText=document.getElementById('cultist-cd-text');
    cdFill.style.width='100%';cdText.innerText='COOLDOWN';cdText.style.color='#ff0000';
    let cdStart=Date.now();
    const cdInterval=setInterval(()=>{const elapsed=Date.now()-cdStart;const pct=Math.max(0,100-elapsed/150);cdFill.style.width=pct+'%';
        if(pct<=0){clearInterval(cdInterval);cultSacrificeCooldown=false;cdFill.style.width='0%';cdText.innerText='READY';cdText.style.color='#00ff88';}},50);
}

function handleClassSweep(linesCleared,baseAtk){
    if(!activeClass||gameMode!=='mutator')return baseAtk;
    if(activeClass==='high_roller'){
        let atk=Math.floor(baseAtk*0.5);
        if(Math.random()<hrJackpotChance){spinSlots(true);sysMsg('JACKPOT! 20 LINES!');if(socket)socket.emit('send_garbage',{mode:'mutator',amount:20});hrFloorStep++;hrFloor=[0.001,0.01,0.05][Math.min(hrFloorStep,2)];hrJackpotChance=hrFloor;}else{hrJackpotChance+=0.002;spinSlots(false);}updateJackpotUI();return atk;
    }
    if(activeClass==='cultist'){
        if(cultExorcismReady){let gc=0;p1.grid.forEach(row=>{if(row.includes('#555'))gc++;});for(let y=ROWS-1;y>=0;y--){if(p1.grid[y].includes('#555')){p1.grid.splice(y,1);p1.grid.unshift(Array(COLS).fill(0));}}const sent=Math.floor(gc*1.5);sysMsg('EXORCISM! Sent '+sent+' lines!');cultRunes=0;cultExorcismReady=false;updateRuneUI();return sent;}return baseAtk;
    }
    if(activeClass==='combo_sniper'){
        if(linesCleared>=3){const dmg=Math.min(19,baseAtk+Math.floor(1.5*sniperBullets));sysMsg('FIRE! '+dmg+' lines targeted!');sniperBullets=0;updateMagazineUI();if(socket&&sniperTargetId)socket.emit('send_garbage',{mode:'mutator',amount:dmg,targetId:sniperTargetId});return 0;}
        else{sniperBullets=Math.min(10,sniperBullets+(linesCleared===1?1:2));updateMagazineUI();if(socket)socket.emit('request_highest_board');return 0;}
    }
    return baseAtk;
}

// === ADMIN PANEL ===
let adminOpen=false;
function toggleAdmin(){adminOpen=!adminOpen;document.getElementById('admin-panel').style.display=adminOpen?'flex':'none';if(adminOpen)refreshAdminList();}
function refreshAdminList(){
    const list=document.getElementById('admin-player-list');list.innerHTML='';
    onlinePlayersList.forEach(p=>{
        const row=document.createElement('div');row.className='admin-player-row';
        row.innerHTML=`<span>${p.username} <span class="status-tag status-${p.status}">${p.status}</span></span>
        <div style="display:flex;gap:4px;align-items:center;">
        <select id="to-min-${p.id}" style="width:55px;background:#111;color:#fff;border:1px solid #555;font-size:10px;padding:2px;border-radius:2px;">
        <option value="1">1m</option><option value="5" selected>5m</option><option value="15">15m</option><option value="30">30m</option><option value="60">1h</option><option value="1440">24h</option>
        </select>
        <button class="admin-btn danger" style="width:auto;padding:4px 8px;font-size:10px;" onclick="adminTimeout('${p.id}','${p.username}')">TIMEOUT</button></div>`;
        list.appendChild(row);
    });
}
function adminTimeout(pid,name){const sel=document.getElementById('to-min-'+pid);const mins=sel?sel.value:'5';if(!confirm('Timeout '+name+' for '+mins+' minutes?'))return;if(socket)socket.emit('admin_timeout',{targetId:pid,minutes:mins});}
function adminRestartFFA(){if(!confirm('Restart FFA lobby?'))return;if(socket)socket.emit('admin_restart_ffa');}
function adminRestartMutator(){if(!confirm('Restart Mutator lobby?'))return;if(socket)socket.emit('admin_restart_mutator');}
function adminRestartServer(){if(!confirm('RESTART SERVER? All players will be disconnected!'))return;if(socket)socket.emit('admin_restart_server');}

// === CONNECT ===
function connect(){
    if(socket)return;socket=io();
    socket.on('login_response',d=>{if(d.success){navTo('scr-main');document.getElementById('display-user').innerHTML=formatUserHTML(d.username);document.getElementById('display-wins').innerText=d.wins;document.getElementById('display-apm').innerText=d.bestAPM;document.getElementById('chat-open-btn').style.display='block';document.getElementById('players-btn').style.display='block';if(d.username==='John')document.getElementById('admin-toggle').style.display='block';}else{alert(d.msg);}});
    socket.on('leaderboard_update',d=>{const w=document.getElementById('lb-wins');w.innerHTML='';d.wins.forEach((p,i)=>{w.innerHTML+=`<div class="lb-item"><span class="rank-num">${i+1}.</span><span>${formatUserHTML(p.name)}</span><span style="font-weight:bold;color:var(--accent);">${p.val} W</span></div>`;});const c=document.getElementById('lb-combo');c.innerHTML='';if(d.combos)d.combos.forEach((p,i)=>{c.innerHTML+=`<div class="lb-item"><span class="rank-num">${i+1}.</span><span>${formatUserHTML(p.name)}</span><span style="font-weight:bold;color:var(--accent);">${p.val} x</span></div>`;});});
    socket.on('queue_joined',d=>{showQueueBanner(d.mode,d.teammate||null);});
    socket.on('queue_cancelled',d=>{clearQueueUI();sysMsg(d.reason||'Queue cancelled.');});
    socket.on('receive_team_invite',d=>{showIncoming('team',d.fromId,d.fromName);});
    socket.on('receive_duel_challenge',d=>{showIncoming('duel',d.fromId,d.fromName);});
    socket.on('team_invite_cancelled',d=>{if(pendingInviteId===d.fromId){document.getElementById('incoming-popup').style.display='none';pendingInviteType=null;pendingInviteId=null;}});
    socket.on('player_list_update',list=>{onlinePlayersList=list;if(isPlayersOpen)refreshPlayerList();if(adminOpen)refreshAdminList();});

    // FFA/Mutator
    socket.on('lobby_update',d=>{if((gameMode==='ffa'||gameMode==='mutator')&&!gameActive){document.getElementById('cnt-txt').innerText='Waiting for players... ('+d.count+'/2)';}});
    socket.on('ffa_joined',d=>{if(gameMode==='ffa'&&!gameActive){document.getElementById('cnt-txt').innerText='Waiting for players... ('+d.count+'/2)';}});
    socket.on('mm_joined',d=>{if(gameMode==='mutator'&&!gameActive){document.getElementById('cnt-txt').innerText='Waiting for players... ('+d.count+'/2)';}});
    socket.on('start_countdown',d=>{if(gameMode==='zen'||gameMode==='apm_test'||gameMode==='duel'||gameMode==='2v2'||gameMode==='menu')return;
        setupGameUI();document.getElementById('overlay-results').classList.add('hidden');
        const ov=document.getElementById('overlay-cnt'),tx=document.getElementById('cnt-txt');ov.classList.remove('hidden');inputLocked=true;
        const iv=setInterval(()=>{const tl=Math.ceil((d.targetTime-Date.now())/1000);if(tl>0)tx.innerText=tl;else{clearInterval(iv);ov.classList.add('hidden');}},100);});
    socket.on('match_start',d=>{if(gameMode==='zen'||gameMode==='apm_test'||gameMode==='duel'||gameMode==='2v2')return;
        inputLocked=false;isSpectator=false;document.getElementById('p1-root').style.opacity='1';document.getElementById('overlay-cnt').classList.add('hidden');
        if(d.mode==='mutator'){
            const me=d.players.find(p=>p.id===socket.id);
            startMutatorGame(d.seed,me?me.className:'high_roller');
            const grid=document.getElementById('ffa-grid');grid.innerHTML='';
            d.players.forEach(p=>{if(p.id!==socket.id){const dv=document.createElement('div');dv.className='mini-card';dv.innerHTML=`<div style="font-size:10px;color:#888">${formatUserHTML(p.username)}</div><canvas id="cvs_${p.id}" width="80" height="520"></canvas>`;grid.appendChild(dv);}});
        } else {gameMode=d.mode;setupOnlineGame(d.seed,d.players);}});
    socket.on('receive_garbage',n=>{if((gameMode==='ffa'||gameMode==='duel'||gameMode==='2v2'||gameMode==='mutator')&&!isSpectator){let amt=n;if(activeClass==='cultist'&&gameMode==='mutator')amt=Math.ceil(n*1.5);p1.receiveGarbage(amt);}});
    socket.on('enemy_board_update',d=>{if(gameMode==='ffa'||gameMode==='duel'||gameMode==='2v2'||gameMode==='mutator')drawEnemy(d.id,d.grid);});
    socket.on('elimination',d=>{feed(`${formatUserHTML(d.username)} eliminated by ${formatUserHTML(d.killer)}!`);});
    socket.on('request_win_stats',()=>{socket.emit('match_won',p1.getStats());});
    socket.on('match_summary',res=>{if(gameMode==='zen'||gameMode==='apm_test'||gameMode==='duel'||gameMode==='2v2')return;gameActive=false;const ov=document.getElementById('overlay-results'),tb=document.getElementById('results-body');tb.innerHTML='';res.forEach(r=>{tb.innerHTML+=`<tr><td class="${r.place===1?'rank-1':''}">${r.place}</td><td>${formatUserHTML(r.username)}</td><td>${r.durationStr}</td><td>${r.apm}</td><td>${r.pps}</td><td>${r.sent}</td><td>${r.recv}</td></tr>`;});ov.classList.remove('hidden');let t=5;const sp=document.getElementById('res-timer');sp.innerText=t;const iv=setInterval(()=>{t--;sp.innerText=t;if(t<=0)clearInterval(iv);},1000);});
    socket.on('lobby_reset',()=>{if(gameMode==='zen'||gameMode==='apm_test'||gameMode==='duel'||gameMode==='2v2'||gameMode==='menu')return;
        document.getElementById('overlay-results').classList.add('hidden');
        // Auto-rejoin the same lobby instead of going home
        gameActive=false;isSpectator=false;
        document.getElementById('overlay-cnt').classList.remove('hidden');document.getElementById('cnt-txt').innerText='Waiting for players...';inputLocked=true;
        if(gameMode==='mutator'&&activeClass){socket.emit('join_mutator_queue',{className:activeClass});}
        else if(gameMode==='ffa'){socket.emit('join_ffa');}
        else{setTimeout(goHome,1000);}
    });
    socket.on('ffa_spectate',d=>{if(gameMode==='zen'||gameMode==='apm_test'||gameMode==='duel'||gameMode==='2v2')return;setTimeout(()=>{isSpectator=true;gameMode='ffa';setupGameUI();document.getElementById('p1-root').style.opacity='0.3';setupOnlineGame(d.seed,d.players);},1000);});
    socket.on('update_my_wins',w=>document.getElementById('display-wins').innerText=w);
    socket.on('sniper_target',d=>{sniperTargetId=d.id;sniperTargetName=d.username;document.getElementById('sniper-target-name').innerText=d.username;updateSniperCrosshair();});
    socket.on('leader_info',d=>{/* High roller jackpot targets leader on server side */});

    // Duel
    socket.on('duel_start',d=>{clearQueueUI();document.getElementById('incoming-popup').style.display='none';currentDuel={duelId:d.duelId,opponentId:d.opponent.id,p1Id:d.p1Id,p2Id:d.p2Id,p1Name:d.p1Name,p2Name:d.p2Name};sysMsg('DUEL: '+d.p1Name+' vs '+d.p2Name);document.getElementById('duel-hud-p1').innerText=d.p1Name;document.getElementById('duel-hud-p2').innerText=d.p2Name;document.getElementById('duel-hud-s1').innerText='0';document.getElementById('duel-hud-s2').innerText='0';document.getElementById('duel-hud-round').innerText='ROUND 1';document.getElementById('duel-hud').style.display='flex';startDuelGame(d.seed);const grid=document.getElementById('ffa-grid');const d2=document.createElement('div');d2.className='mini-card';d2.innerHTML=`<div style="font-size:10px;color:#888">${formatUserHTML(d.opponent.username)}</div><canvas id="cvs_${d.opponent.id}" width="80" height="520"></canvas>`;grid.appendChild(d2);});
    socket.on('duel_round_result',d=>{gameActive=false;const s1=d.scores[d.p1Id]||0,s2=d.scores[d.p2Id]||0;document.getElementById('duel-hud-s1').innerText=s1;document.getElementById('duel-hud-s2').innerText=s2;document.getElementById('duel-hud-round').innerText='ROUND '+d.round;const ov=document.getElementById('overlay-cnt'),tx=document.getElementById('cnt-txt');ov.classList.remove('hidden');tx.innerText=d.roundWinnerName+' wins!';setTimeout(()=>{tx.innerText='3';setTimeout(()=>tx.innerText='2',1000);setTimeout(()=>tx.innerText='1',2000);setTimeout(()=>{ov.classList.add('hidden');startDuelGame(d.newSeed);if(currentDuel){const opId=currentDuel.p1Id===socket.id?currentDuel.p2Id:currentDuel.p1Id;const opN=currentDuel.p1Id===socket.id?currentDuel.p2Name:currentDuel.p1Name;const d2=document.createElement('div');d2.className='mini-card';d2.innerHTML=`<div style="font-size:10px;color:#888">${formatUserHTML(opN)}</div><canvas id="cvs_${opId}" width="80" height="520"></canvas>`;document.getElementById('ffa-grid').appendChild(d2);}},3000);},2000);});
    socket.on('duel_end',d=>{gameActive=false;document.getElementById('duel-hud').style.display='none';document.getElementById('duel-results-title').innerText=d.winnerName+' WINS!';document.getElementById('duel-results-score').innerText=(d.finalScores[d.p1Id]||0)+' - '+(d.finalScores[d.p2Id]||0);document.getElementById('duel-results-sub').innerText=d.reason||'Returning to menu...';document.getElementById('duel-results').style.display='flex';currentDuel=null;setTimeout(()=>{document.getElementById('duel-results').style.display='none';goHome();},5000);});
    // 2v2
    socket.on('twovtwo_start',d=>{clearQueueUI();current2v2={gameId:d.gameId,t1:d.t1,t2:d.t2};document.getElementById('duel-hud-p1').innerText=d.t1.map(p=>p.name).join(' & ');document.getElementById('duel-hud-p2').innerText=d.t2.map(p=>p.name).join(' & ');document.getElementById('duel-hud-s1').innerText='0';document.getElementById('duel-hud-s2').innerText='0';document.getElementById('duel-hud-round').innerText='ROUND 1';document.getElementById('duel-hud').style.display='flex';start2v2Game(d.seed);const grid=document.getElementById('ffa-grid');[...d.t1,...d.t2].filter(p=>p.id!==socket.id).forEach(p=>{const d2=document.createElement('div');d2.className='mini-card';d2.innerHTML=`<div style="font-size:10px;color:#888">${formatUserHTML(p.name)}</div><canvas id="cvs_${p.id}" width="80" height="520"></canvas>`;grid.appendChild(d2);});});
    socket.on('twovtwo_round_result',d=>{gameActive=false;document.getElementById('duel-hud-s1').innerText=d.scores.t1;document.getElementById('duel-hud-s2').innerText=d.scores.t2;document.getElementById('duel-hud-round').innerText='ROUND '+d.round;const ov=document.getElementById('overlay-cnt'),tx=document.getElementById('cnt-txt');ov.classList.remove('hidden');tx.innerText=d.roundWinnerNames+' win!';setTimeout(()=>{tx.innerText='3';setTimeout(()=>tx.innerText='2',1000);setTimeout(()=>tx.innerText='1',2000);setTimeout(()=>{ov.classList.add('hidden');start2v2Game(d.newSeed);if(current2v2){[...current2v2.t1,...current2v2.t2].filter(p=>p.id!==socket.id).forEach(p=>{const d2=document.createElement('div');d2.className='mini-card';d2.innerHTML=`<div style="font-size:10px;color:#888">${formatUserHTML(p.name)}</div><canvas id="cvs_${p.id}" width="80" height="520"></canvas>`;document.getElementById('ffa-grid').appendChild(d2);});}},3000);},2000);});
    socket.on('twovtwo_end',d=>{gameActive=false;document.getElementById('duel-hud').style.display='none';document.getElementById('duel-results-title').innerText=d.winNames+' WIN!';document.getElementById('duel-results-score').innerText=d.scores.t1+' - '+d.scores.t2;document.getElementById('duel-results-sub').innerText=d.reason||'';document.getElementById('duel-results').style.display='flex';current2v2=null;setTimeout(()=>{document.getElementById('duel-results').style.display='none';goHome();},5000);});
    socket.on('receive_chat',d=>{const box=document.getElementById('chat-history');box.innerHTML+=`<div><span style="color:var(--accent);font-weight:bold;">${formatUserHTML(d.user)}:</span> ${d.text}</div>`;box.scrollTop=box.scrollHeight;if(!isChatOpen){unreadChatCount++;const bg=document.getElementById('chat-badge');bg.innerText=unreadChatCount;bg.classList.remove('hidden');}});
    socket.on('receive_all_stats',d=>{statsCache=d;const list=document.getElementById('stats-list');list.innerHTML='';Object.keys(d).sort((a,b)=>{const ga=u=>{const h=d[u].history||[];return h.length?h.reduce((s,x)=>s+(x.apm||0),0)/h.length:0;};return ga(b)-ga(a);}).forEach(u=>{const h=d[u].history||[];let avg=h.length?(h.reduce((s,x)=>s+(x.apm||0),0)/h.length).toFixed(0):0;const div=document.createElement('div');div.className='player-item';div.innerHTML=`<span>${formatUserHTML(u)}</span> <span style="color:#666">${avg} APM</span>`;div.onclick=()=>{document.querySelectorAll('.player-item').forEach(el=>el.classList.remove('selected'));div.classList.add('selected');showStatDetails(u);};list.appendChild(div);});});
    socket.on('bugs_update',d=>{const c=document.getElementById('bugs-list-container');c.innerHTML='';if(!d.length){c.innerHTML='<div style="text-align:center;color:#666;padding:40px;">No reports yet.</div>';return;}[...d].reverse().forEach(b=>{c.innerHTML+=`<div class="bug-item"><div class="bug-topic">${b.topic}</div><div class="bug-meta">by ${formatUserHTML(b.author)} - ${new Date(b.date).toLocaleDateString()}</div><div class="bug-body">${b.body}</div></div>`;});});
    socket.on('force_disconnect',msg=>{alert(msg);goHome();});
}

function showStatDetails(user){const d=statsCache[user],div=document.getElementById('stats-detail');let avgAPM=0,avgPPS=0,avgSent=0,avgRecv=0,games=d.history?d.history.length:0;if(games>0){avgAPM=(d.history.reduce((a,b)=>a+(b.apm||0),0)/games).toFixed(1);avgPPS=(d.history.reduce((a,b)=>a+parseFloat(b.pps||0),0)/games).toFixed(2);avgSent=(d.history.reduce((a,b)=>a+(b.sent||0),0)/games).toFixed(1);avgRecv=(d.history.reduce((a,b)=>a+(b.received||0),0)/games).toFixed(1);}let html=`<div class="stat-user-title">${formatUserHTML(user)}</div><span class="stat-section-label">CAREER HIGHS</span><div class="stat-row"><div class="stat-card"><div>WINS</div><div class="stat-card-val highlight">${d.wins}</div></div><div class="stat-card"><div>MAX COMBO</div><div class="stat-card-val highlight">${d.bestCombo||0}</div></div><div class="stat-card"><div>BEST APM</div><div class="stat-card-val highlight">${d.bestAPM||0}</div></div></div><span class="stat-section-label">AVERAGES</span><div class="stat-row"><div class="stat-card"><div>APM</div><div class="stat-card-val">${avgAPM}</div></div><div class="stat-card"><div>PPS</div><div class="stat-card-val">${avgPPS}</div></div><div class="stat-card"><div>SENT</div><div class="stat-card-val">${avgSent}</div></div></div><span class="stat-section-label">RECENT (${games})</span><div class="history-wrapper"><table class="history-table"><thead><tr><th>DATE</th><th>PLACE</th><th>APM</th><th>PPS</th><th>SENT</th><th>COMBO</th></tr></thead><tbody>`;if(d.history)[...d.history].reverse().forEach(h=>{const dt=new Date(h.date).toLocaleDateString();const pc=h.place===1?'#ffcc00':'#fff';html+=`<tr><td>${dt}</td><td style="color:${pc};font-weight:bold;">#${h.place}</td><td>${h.apm}</td><td>${h.pps}</td><td>${h.sent}</td><td>${h.maxCombo||0}</td></tr>`;});html+=`</tbody></table></div>`;div.innerHTML=html;}
function switchStatsTab(tab){const gl=document.getElementById('stats-layout'),dl=document.getElementById('stats-duel-layout'),gb=document.getElementById('stats-tab-general'),db=document.getElementById('stats-tab-duels');if(tab==='general'){gb.style.background='var(--accent)';gb.style.color='#000';db.style.background='#222';db.style.color='#888';gl.style.display='flex';dl.style.display='none';}else{gb.style.background='#222';gb.style.color='#888';db.style.background='#ff00de';db.style.color='#fff';gl.style.display='none';dl.style.display='block';showDuelHistory();}}
function showDuelHistory(){const div=document.getElementById('stats-duel-content');if(!statsCache||!Object.keys(statsCache).length){div.innerHTML='<div style="text-align:center;color:#666;margin-top:50px;">No stats.</div>';return;}let all=[];for(const[u,d] of Object.entries(statsCache)){if(d.history)d.history.forEach(h=>{if(h.type==='duel'||h.type==='2v2')all.push({player:u,date:h.date,place:h.place,vs:h.vs||'?',score:h.score||'?',type:h.type||'duel'});});}all.sort((a,b)=>new Date(b.date)-new Date(a.date));if(!all.length){div.innerHTML='<div style="text-align:center;color:#666;margin-top:50px;">No records.</div>';return;}let h='<table class="history-table"><thead><tr><th>DATE</th><th>TYPE</th><th>PLAYER</th><th>VS</th><th>RESULT</th><th>SCORE</th></tr></thead><tbody>';all.forEach(d=>{const dt=new Date(d.date).toLocaleDateString();const rc=d.place===1?'#00ffcc':'#ff5555';const rt=d.place===1?'WIN':'LOSS';h+=`<tr><td>${dt}</td><td>${d.type.toUpperCase()}</td><td>${formatUserHTML(d.player)}</td><td>${formatUserHTML(d.vs)}</td><td style="color:${rc};font-weight:bold;">${rt}</td><td>${d.score}</td></tr>`;});h+='</tbody></table>';div.innerHTML=h;}

function setupOnlineGame(seed,players){gameActive=true;p1.initRNG(seed);p1.reset();const grid=document.getElementById('ffa-grid');grid.innerHTML='';players.forEach(p=>{if(p.id!==socket.id){const d=document.createElement('div');d.className='mini-card';d.innerHTML=`<div style="font-size:10px;color:#888">${formatUserHTML(p.username)}</div><canvas id="cvs_${p.id}" width="80" height="520"></canvas>`;grid.appendChild(d);}});loop();}
function drawEnemy(id,grid){const cvs=document.getElementById(`cvs_${id}`);if(!cvs)return;const ctx=cvs.getContext('2d');ctx.fillStyle='#000';ctx.fillRect(0,0,80,520);if(grid)grid.forEach((r,y)=>r.forEach((v,x)=>{if(v){ctx.fillStyle=v;ctx.fillRect(x*20,y*20,19,19);}}));}
function feed(msg){const f=document.getElementById('kill-feed');const d=document.createElement('div');d.className='feed-msg';d.innerHTML=msg;f.appendChild(d);setTimeout(()=>d.remove(),4000);}
function sendChat(e){if(e.key==='Enter'){const input=document.getElementById('chat-input');const txt=input.value.trim();if(txt&&socket){socket.emit('send_chat',txt);input.value='';}}}

// === GAME ENGINE ===
class SeededRNG{constructor(s){this.s=s;}next(){this.s=(this.s*9301+49297)%233280;return this.s/233280;}}
class Player{
    constructor(){this.ctx=document.getElementById('p1').getContext('2d');this.nCtx=document.getElementById('p1-n').getContext('2d');this.hCtx=document.getElementById('p1-h').getContext('2d');this.gBar=document.getElementById('p1-g');this.elSent=document.getElementById('s-sent');this.elRecv=document.getElementById('s-recv');this.elTime=document.getElementById('s-time');this.elPPS=document.getElementById('s-pps');this.elAPM=document.getElementById('s-apm');this.popAct=document.getElementById('pop-action');this.popCmbo=document.getElementById('pop-combo');this.popB2B=document.getElementById('pop-b2b');this.popSent=document.getElementById('pop-sent');this.rotation=0;this.grid=Array.from({length:ROWS},()=>Array(COLS).fill(0));this.bag=[];this.queue=[];this.holdId=null;this.canHold=true;this.pendingG=0;this.combo=-1;this.maxCombo=0;this.b2b=0;this.dropCounter=0;this.lockTimer=0;this.lockMoves=0;this.dasTimer=0;this.arrTimer=0;this.piecesPlaced=0;this.linesSentTotal=0;this.linesRecvTotal=0;this.rng=new SeededRNG(1);this.startTime=Date.now();}
    getStats(){const sec=(Date.now()-this.startTime)/1000;return{apm:(sec>0?Math.floor((this.linesSentTotal/sec)*60):0),pps:(sec>0?(this.piecesPlaced/sec).toFixed(2):"0.00"),sent:this.linesSentTotal,recv:this.linesRecvTotal,maxCombo:this.maxCombo};}
    getBoardHeight(){let h=0;for(let y=0;y<ROWS;y++){if(this.grid[y].some(v=>v!==0)){h=ROWS-y;break;}}return h;}
    initRNG(s){this.rng=new SeededRNG(s);}
    reset(){this.grid.forEach(r=>r.fill(0));this.bag=[];this.queue=[];this.piecesPlaced=0;this.linesSentTotal=0;this.linesRecvTotal=0;this.pendingG=0;this.startTime=Date.now();this.holdId=null;this.canHold=true;this.maxCombo=0;this.rotation=0;this.drawSide(this.hCtx,[this.holdId]);for(let i=0;i<4;i++)this.queue.push(this.pull());this.spawn();const myName=document.getElementById('username')?document.getElementById('username').value.trim():'';if(myName==='La Bamba\u{1F0CF}'){for(let i=0;i<100;i++){const r=Array(COLS).fill('#555');r[Math.floor(Math.random()*COLS)]=0;this.grid.shift();this.grid.push(r);}}}
    pull(){if(!this.bag.length){this.bag=[0,1,2,3,4,5,6];for(let i=6;i>0;i--){const j=Math.floor(this.rng.next()*(i+1));[this.bag[i],this.bag[j]]=[this.bag[j],this.bag[i]];}}return this.bag.pop();}
    spawn(id=this.queue.shift()){this.queue.push(this.pull());this.rotation=0;this.active={pos:{x:0,y:-1},matrix:PIECES[id],id:id,color:COLORS[id]};this.lastMoveRotate=false;this.lockTimer=0;this.lockMoves=0;if(this.collide()){}this.drawSide(this.nCtx,this.queue);this.sendBoard();}
    collide(m=this.active.matrix,p=this.active.pos){for(let y=0;y<m.length;y++)for(let x=0;x<m[y].length;x++)if(m[y][x]){const gx=x+p.x,gy=y+p.y;if(gx<0||gx>=COLS)return true;if(gy>=ROWS)return true;if(gy>=0&&this.grid[gy][gx])return true;}return false;}
    rotate(dir=1){const cR=this.rotation;let nR=(cR+dir+4)%4;const nM=this.active.matrix[0].map((_,i)=>this.active.matrix.map(row=>row[i]).reverse());if(this.active.id===1)return;const kT=this.active.id===0?OFFSETS_I:OFFSETS_JLSTZ;const kRI=KICK_INDEX[`${cR}_${nR}`];const kicks=kT[kRI];const iP={x:this.active.pos.x,y:this.active.pos.y};for(let i=0;i<kicks.length;i++){this.active.pos.x=iP.x+kicks[i][0];this.active.pos.y=iP.y-kicks[i][1];if(!this.collide(nM,this.active.pos)){this.applyRotation(nM,nR);return;}}const sK=[[-1,0],[1,0],[-2,0],[2,0],[-3,0]];for(let k of sK){this.active.pos.x=iP.x+k[0];this.active.pos.y=iP.y+k[1];if(!this.collide(nM,this.active.pos)){this.applyRotation(nM,nR);return;}}this.active.pos.x=iP.x;this.active.pos.y=iP.y;}
    applyRotation(m,r){this.active.matrix=m;this.rotation=r;this.lastMoveRotate=true;if(this.isGrounded()&&this.lockMoves<15){this.lockTimer=0;this.lockMoves++;}this.sendBoard();}
    move(d){this.active.pos.x+=d;if(this.collide())this.active.pos.x-=d;else{this.lastMoveRotate=false;if(this.isGrounded()&&this.lockMoves<15){this.lockTimer=0;this.lockMoves++;}this.sendBoard();}}
    isGrounded(){this.active.pos.y++;const hit=this.collide();this.active.pos.y--;return hit;}
    hardDrop(){while(!this.collide())this.active.pos.y++;this.active.pos.y--;this.lock();}
    hold(slot=1){const c=this.active.id;if(slot===1){if(!this.canHold)return;if(this.holdId===null){this.holdId=c;this.spawn();}else{const t=this.holdId;this.holdId=c;this.spawn(t);}this.canHold=false;}this.drawSide(this.hCtx,[this.holdId]);}
    lock(){let entirelyInRed=true;this.active.matrix.forEach((r,y)=>r.forEach((v,x)=>{if(v){const gy=y+this.active.pos.y;if(gy>=0){this.grid[gy][x+this.active.pos.x]=this.active.color;if(gy>=4)entirelyInRed=false;}}}));this.piecesPlaced++;const linesCleared=this.sweep();
        if(entirelyInRed&&linesCleared===0){if((gameMode==='duel'||gameMode==='2v2')&&socket){socket.emit(gameMode==='duel'?'duel_report_loss':'twovtwo_report_loss',this.getStats());gameActive=false;return;}else if(gameMode==='mutator'&&socket){socket.emit('player_died',this.getStats());isSpectator=true;document.getElementById('p1-root').style.opacity='0.3';return;}else if(gameMode!=='zen'&&gameMode!=='apm_test'&&socket){socket.emit('player_died',this.getStats());isSpectator=true;document.getElementById('p1-root').style.opacity='0.3';return;}else{this.reset();return;}}
        this.canHold=true;this.spawn();}
    sweep(){let lines=0,isPC=true;for(let y=ROWS-1;y>=0;y--){if(this.grid[y].every(v=>v!==0)){this.grid.splice(y,1);this.grid.unshift(Array(COLS).fill(0));lines++;y++;}else if(this.grid[y].some(v=>v!==0)){isPC=false;}}
        if(lines>0){this.combo++;if(this.combo>this.maxCombo)this.maxCombo=this.combo;let atk=0,txt=(lines==1)?"SINGLE":(lines==2)?"DOUBLE":(lines==3)?"TRIPLE":"QUAD";atk=(lines==4)?4:(lines-1);if(isPC){txt="ALL CLEAR";atk+=10;}this.showText(this.popAct,txt);if(lines==4){this.b2b++;if(this.b2b>1){atk+=1;this.showText(this.popB2B,"B2B x"+(this.b2b-1));}}else{this.b2b=0;}if(this.combo>0){atk+=Math.floor((this.combo-1)/2);this.showText(this.popCmbo,this.combo+" COMBO");}
            // Combo sniper: cancel garbage with base attack, then class handles sending
            let baseAtk=atk;
            if(gameMode==='mutator'&&activeClass){atk=handleClassSweep(lines,atk);}
            if(activeClass==='combo_sniper'&&gameMode==='mutator'){
                // Cancel pending garbage using base attack power but don't send cancelled lines
                if(this.pendingG>0){let c=Math.min(this.pendingG,baseAtk);this.pendingG-=c;if(c>0)this.showText(this.popSent,`\u2716${c}`);}
            } else {
                if(atk>0)this.showText(this.popSent,`+${atk}`);if(this.pendingG>0){let c=Math.min(this.pendingG,atk);this.pendingG-=c;atk-=c;}this.linesSentTotal+=atk;if(atk>0&&(gameMode==='ffa'||gameMode==='duel'||gameMode==='2v2'||gameMode==='mutator')){if(socket&&!isSpectator)socket.emit('send_garbage',{mode:gameMode,amount:atk});}
            }
        }else{this.combo=-1;let toPlace=Math.min(this.pendingG,10);this.pendingG-=toPlace;while(toPlace>0){toPlace--;const r=Array(COLS).fill('#555');r[Math.floor(Math.random()*COLS)]=0;this.grid.shift();this.grid.push(r);}}
        this.gBar.style.height=(this.pendingG*B_SIZE)+'px';this.updateStats();return lines;}
    receiveGarbage(n){this.pendingG+=n;this.linesRecvTotal+=n;this.gBar.style.height=(this.pendingG*B_SIZE)+'px';this.updateStats();}
    updateStats(){const sec=(Date.now()-this.startTime)/1000;this.elSent.innerText=this.linesSentTotal;this.elRecv.innerText=this.linesRecvTotal;this.elPPS.innerText=(sec>0?(this.piecesPlaced/sec).toFixed(2):"0.00");this.elAPM.innerText=(sec>0?Math.floor((this.linesSentTotal/sec)*60):0);let ds=sec;if(gameMode==='apm_test')ds=60-sec;if(ds<0)ds=0;this.elTime.innerText=`${Math.floor(ds/60).toString().padStart(2,'0')}:${Math.floor(ds%60).toString().padStart(2,'0')}`;}
    drawSide(ctx,ids){ctx.fillStyle='#000';ctx.fillRect(0,0,ctx.canvas.width,ctx.canvas.height);ids.forEach((id,i)=>{if(id!==null){ctx.fillStyle=COLORS[id];const shape=PIECES[id];const pw=shape[0].length*20,ph=shape.length*20;const ox=(ctx.canvas.width-pw)/2,oy=i*80+(80-ph)/2;shape.forEach((row,y)=>{row.forEach((v,x)=>{if(v)ctx.fillRect(ox+x*20,oy+y*20,19,19);});});}});}
    sendBoard(){if(socket&&!isSpectator){const d=JSON.parse(JSON.stringify(this.grid));this.active.matrix.forEach((r,y)=>r.forEach((v,x)=>{if(v&&d[y+this.active.pos.y]){d[y+this.active.pos.y][x+this.active.pos.x]=this.active.color;}}));socket.emit('update_board',{grid:d,boardHeight:this.getBoardHeight()});}}
    showText(el,msg){el.innerText=msg;el.style.opacity=1;setTimeout(()=>el.style.opacity=0,1000);}
    update(dt){let dropSpeed=700;if(gameMode==='ffa'||gameMode==='duel'||gameMode==='2v2'||gameMode==='mutator'){const elapsed=(Date.now()-this.startTime)/1000;const reduction=Math.floor(elapsed/30)*210;dropSpeed=Math.max(100,700-reduction);}this.dropCounter+=dt;if(this.dropCounter>dropSpeed){this.active.pos.y++;if(this.collide()){this.active.pos.y--;}else{this.lockTimer=0;this.lockMoves=0;this.lastMoveRotate=false;}this.dropCounter=0;}if(this.isGrounded()){this.lockTimer+=dt;if(this.lockTimer>500||this.lockMoves>=15)this.lock();}this.sendBoard();}
    draw(){this.ctx.fillStyle='#000';this.ctx.fillRect(0,0,120,900);this.ctx.fillStyle='rgba(255,0,0,0.2)';this.ctx.fillRect(0,0,120,120);this.ctx.strokeStyle='rgba(255,255,255,0.1)';this.ctx.lineWidth=1;this.ctx.beginPath();for(let x=1;x<COLS;x++){this.ctx.moveTo(x*B_SIZE,4*B_SIZE);this.ctx.lineTo(x*B_SIZE,ROWS*B_SIZE);}for(let y=4;y<ROWS;y++){this.ctx.moveTo(0,y*B_SIZE);this.ctx.lineTo(COLS*B_SIZE,y*B_SIZE);}this.ctx.stroke();this.grid.forEach((r,y)=>r.forEach((v,x)=>{if(v){this.ctx.fillStyle=v;this.ctx.fillRect(x*B_SIZE,y*B_SIZE,B_SIZE-1,B_SIZE-1);}}));if(this.active&&!isSpectator){let g={...this.active.pos};while(!this.collide(this.active.matrix,g))g.y++;g.y--;this.ctx.fillStyle='rgba(255,255,255,0.15)';this.active.matrix.forEach((r,y)=>r.forEach((v,x)=>{if(v)this.ctx.fillRect((g.x+x)*B_SIZE,(g.y+y)*B_SIZE,B_SIZE-1,B_SIZE-1);}));this.ctx.fillStyle=this.active.color;this.active.matrix.forEach((r,y)=>r.forEach((v,x)=>{if(v)this.ctx.fillRect((this.active.pos.x+x)*B_SIZE,(this.active.pos.y+y)*B_SIZE,B_SIZE-1,B_SIZE-1);}));}}
}

const p1=new Player();const keys=new Set();
const ctrl={left:'ArrowLeft',right:'ArrowRight',rotate:'ArrowUp',soft:'ArrowDown',hard:'Space',hold:'ShiftLeft',ability:'KeyZ'};
window.addEventListener('keydown',e=>{
    if(gameMode==='zen'||gameMode==='apm_test'){if(document.activeElement.tagName!=='INPUT'&&e.code==='KeyR'){if(gameMode==='zen')startZen();if(gameMode==='apm_test')startAPMTest();return;}}
    if(!inputLocked&&gameActive&&!isSpectator){
        if(["Space","ArrowUp","ArrowDown"].includes(e.code))e.preventDefault();
        // Z key = ability
        if(e.code===ctrl.ability&&!keys.has(e.code)){keys.add(e.code);if(activeClass==='cultist')cultistSacrifice();return;}
        if(!keys.has(e.code)){keys.add(e.code);if(e.code==ctrl.rotate)p1.rotate();if(e.code==ctrl.hold)p1.hold(1);if(e.code==ctrl.hard){p1.hardDrop();}if(e.code==ctrl.left||e.code==ctrl.right){p1.dasTimer=0;p1.arrTimer=0;p1.move(e.code==ctrl.left?-1:1);}}
    }
});
window.addEventListener('keyup',e=>keys.delete(e.code));
let lastT=0;
function loop(t=0){const dt=t-lastT;lastT=t;if(gameActive){if(!isSpectator&&!inputLocked){if(keys.has(ctrl.soft)){p1.active.pos.y++;if(p1.collide())p1.active.pos.y--;else{p1.lastMoveRotate=false;p1.lockTimer=0;}}if(keys.has(ctrl.left)||keys.has(ctrl.right)){const d=keys.has(ctrl.left)?-1:1;p1.dasTimer+=dt;if(p1.dasTimer>130){p1.arrTimer+=dt;if(p1.arrTimer>0){p1.move(d);p1.arrTimer=0;}}}p1.update(dt);p1.updateStats();}p1.draw();}requestAnimationFrame(loop);}
</script>
</body>
</html>
