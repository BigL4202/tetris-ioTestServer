<!DOCTYPE html>
<html>
<head>
    <title>Student Learning Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --accent: #00ffcc;               
            --glow: rgba(0, 255, 204, 0.2);  
            --glow-strong: rgba(0, 255, 204, 0.4);
            --bg-color: #050505;
            --panel-bg: rgba(10, 10, 10, 0.85);
        }

        /* --- GLOBAL LAYOUT --- */
        body { 
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(circle at center, transparent 0%, #000 90%), 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), 
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px; 
            background-attachment: fixed;
            color: #fff; 
            font-family: 'Segoe UI', sans-serif; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            height: 100vh; margin: 0; overflow: hidden; 
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* --- MENUS --- */
        #menu-container { position: absolute; z-index: 100; background: rgba(0,0,0,0.95); width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        
        .screen { display: none; flex-direction: column; align-items: center; width: 100%; max-width: 1200px; transition: transform 0.3s ease; transform: scale(0.95); }
        .active { display: flex; }
        
        h1 { font-size: 60px; margin-bottom: 30px; letter-spacing: 4px; text-align: center; font-weight: 900; text-transform: uppercase; }
        h1 span { background: linear-gradient(135deg, var(--accent), #fff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 30px var(--glow); animation: titlePulse 3s infinite ease-in-out; }
        @keyframes titlePulse { 0%, 100% { filter: drop-shadow(0 0 10px var(--glow)); } 50% { filter: drop-shadow(0 0 25px var(--accent)); } }

        /* --- STATS GRID (NEW FEATURE) --- */
        .stats-grid-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            width: 100%;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .stat-grid-box {
            background: #111; border: 1px solid #333; border-radius: 4px; padding: 15px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 0 10px rgba(0,0,0,0.5); transition: transform 0.2s;
        }
        .stat-grid-box:hover { transform: scale(1.02); border-color: var(--accent); }
        .stat-grid-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; font-weight: bold; }
        .stat-grid-val { font-size: 28px; font-weight: 900; color: #fff; font-family: monospace; }
        .stat-grid-val.highlight { color: var(--accent); text-shadow: 0 0 15px var(--glow); }

        /* --- UI BOTTOM RIGHT (NEW FEATURE) --- */
        #ui-bottom-right { 
            position: fixed; bottom: 10px; right: 10px; z-index: 190; 
            display: flex; flex-direction: column; align-items: flex-end; gap: 10px; 
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        
        .floating-btn { 
            padding: 12px 20px; background: #000; color: var(--accent); 
            border: 1px solid var(--accent); box-shadow: 0 0 15px var(--glow); 
            font-weight: bold; cursor: pointer; font-family: 'Segoe UI', monospace; 
            width: 140px; text-align: center; text-transform: uppercase; letter-spacing: 1px;
            transition: 0.2s;
        }
        .floating-btn:hover { background: var(--accent); color: #000; }
        
        /* Player List Popup */
        #player-list-popup {
            width: 340px; height: 400px; background: rgba(10,10,10,0.98); 
            border: 1px solid var(--accent); display: none; flex-direction: column; 
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        #pl-header { 
            background: #1a1a1a; padding: 12px; font-weight: bold; 
            border-bottom: 1px solid #333; display: flex; 
            justify-content: space-between; align-items: center; 
            color: var(--accent); letter-spacing: 1px;
        }
        #pl-content { flex: 1; overflow-y: auto; padding: 5px; }
        
        .pl-item { 
            padding: 10px; border-bottom: 1px solid #222; cursor: pointer; 
            transition: 0.2s; display: flex; justify-content: space-between; 
            align-items: center; color: #ccc; 
        }
        .pl-item:hover { background: rgba(0, 255, 204, 0.1); color: #fff; padding-left: 15px; }
        .pl-status-idle { color: #888; font-size: 10px; text-transform: uppercase; }
        .pl-status-busy { color: #ff5555; font-size: 10px; text-transform: uppercase; }
        
        /* Challenge Confirm Screen */
        .challenge-confirm { padding: 20px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        .challenge-title { font-size: 18px; margin-bottom: 20px; color: #fff; }
        .btn-confirm { padding: 10px 30px; margin: 5px; cursor: pointer; border: none; font-weight: bold; font-size: 14px; text-transform: uppercase; }
        .btn-yes { background: var(--accent); color: #000; box-shadow: 0 0 10px var(--glow); }
        .btn-no { background: #333; color: #fff; border: 1px solid #555; }
        .btn-no:hover { background: #ff0033; border-color: #ff0033; }

        /* Chat Box */
        #chat-container { 
            width: 340px; display: none; flex-direction: column; 
            background: rgba(10,10,10,0.98); border: 1px solid var(--accent); 
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        #chat-history { height: 250px; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px; border-bottom: 1px solid #333; }
        #chat-input { padding: 12px; border: none; outline: none; background: #000; color: white; font-family: monospace; }
        .chat-line { margin-bottom: 4px; line-height: 1.4; word-wrap: break-word; }
        .chat-user { font-weight: bold; color: var(--accent); margin-right: 5px; }
        .chat-sys { color: #ffcc00; font-style: italic; }
        .chat-duel { color: #ff00de; font-weight: bold; }

        .chat-badge { 
            position: absolute; top: -8px; right: -8px; 
            background: #ff0033; color: white; border-radius: 50%; 
            width: 24px; height: 24px; font-size: 12px; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: bold; box-shadow: 0 0 10px #ff0033; animation: bounce 0.5s;
        }
        @keyframes bounce { 0% { transform: scale(0); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        /* --- EXISTING UI ELEMENTS --- */
        #duel-overlay { position: absolute; top: 20px; z-index: 150; background: rgba(0,0,0,0.95); border: 2px solid var(--accent); padding: 15px 50px; border-radius: 12px; text-align: center; display: none; box-shadow: 0 0 50px var(--glow); }
        .duel-score { font-size: 50px; font-weight: 900; color: #fff; text-shadow: 0 0 20px var(--accent); letter-spacing: 5px; line-height: 1; }
        .duel-names { font-size: 14px; color: #888; margin-top: 10px; text-transform: uppercase; letter-spacing: 3px; }
        
        .invite-card { background: rgba(0, 255, 204, 0.05); border: 1px solid var(--accent); padding: 15px; margin: 10px 0; font-size: 13px; animation: flashInvite 1.5s infinite alternate; text-align: center; }
        @keyframes flashInvite { 0% { border-color: var(--accent); box-shadow: 0 0 5px var(--glow); } 100% { border-color: #fff; box-shadow: 0 0 20px var(--accent); } }

        .tech-panel { background: var(--panel-bg); border: 1px solid var(--accent); box-shadow: 0 0 20px var(--glow); border-radius: 8px; padding: 30px; display: flex; flex-direction: column; align-items: center; backdrop-filter: blur(10px); }
        .input-std { background: #111; border: 1px solid #333; color: #fff; padding: 15px; font-size: 18px; border-radius: 4px; margin: 10px 0; width: 300px; text-align: center; transition: 0.3s; }
        .input-std:focus { border-color: var(--accent); box-shadow: 0 0 15px var(--glow); outline: none; background: #000; }
        
        .btn { padding: 15px 40px; font-size: 16px; cursor: pointer; border: none; font-weight: 800; border-radius: 4px; margin: 8px; width: 320px; text-transform: uppercase; transition: all 0.2s ease-in-out; box-shadow: 0 4px 15px rgba(0,0,0,0.5); letter-spacing: 1px; position: relative; overflow: hidden; }
        .btn:hover { transform: translateY(-2px) scale(1.02); filter: brightness(1.2); letter-spacing: 3px; box-shadow: 0 0 20px var(--glow); }
        .btn-green { background: #00ffcc; color: #000; } .btn-zen { background: #a29bfe; color: #000; } .btn-apm { background: #ff5555; color: #fff; } .btn-ffa { background: #ff9900; color: #000; } .btn-blue { background: #00a8ff; color: #fff; } .btn-pink { background: #ff00de; color: #fff; }

        #main-split { display: flex; flex-direction: row; gap: 30px; align-items: flex-start; margin-top: 20px; }
        .menu-col { width: 360px; display: flex; flex-direction: column; align-items: center; }
        .user-info { margin-bottom: 20px; font-size: 16px; color: #ccc; text-align: center; width: 100%; line-height: 1.6; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .user-info span { color: #fff; font-weight: bold; font-size: 18px; }
        
        .lb-header-text { color: var(--accent); font-size: 14px; font-weight: bold; text-align: center; margin-bottom: 10px; margin-top: 20px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #333; padding-bottom: 5px; width: 100%; }
        .lb-list { width: 100%; font-family: 'Segoe UI', sans-serif; font-size: 13px; color: #fff; height: 300px; overflow-y: auto; }
        .lb-item { display: flex; justify-content: space-between; padding: 8px 5px; border-bottom: 1px solid #1a1a1a; transition: background 0.2s; align-items: center; }
        .lb-item:hover { background: rgba(255,255,255,0.05); }
        .rank-num { color: #ffcc00; font-weight: bold; margin-right: 5px; } 
        
        /* Stats Page Layout */
        #stats-layout { display: flex; width: 1000px; height: 600px; gap: 20px; }
        #stats-list { width: 300px; background: #050505; border: 1px solid var(--accent); box-shadow: 0 0 15px var(--glow); border-radius: 4px; overflow-y: auto; padding: 10px; }
        #stats-detail { flex: 1; background: #050505; border: 1px solid var(--accent); box-shadow: 0 0 15px var(--glow); border-radius: 4px; padding: 25px; display: flex; flex-direction: column; overflow: hidden; }
        
        .player-item { padding: 15px; cursor: pointer; border-bottom: 1px solid #222; color: #888; font-weight: bold; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .player-item:hover { background: #111; color: #fff; padding-left: 20px; }
        .player-item.selected { background: rgba(0, 255, 204, 0.1); color: var(--accent); border-left: 4px solid var(--accent); }
        .apm-badge { font-size: 11px; background: #222; color: #fff; padding: 3px 8px; border-radius: 4px; border: 1px solid #444; }
        
        /* Tab Bar */
        .tab-bar { display: flex; border-bottom: 1px solid #333; margin-bottom: 20px; width: 100%; }
        .tab-btn { flex: 1; background: none; border: none; padding: 15px; color: #666; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.2s; }
        .tab-btn:hover { color: #fff; }
        .tab-btn.active { color: var(--accent); border-bottom: 3px solid var(--accent); }

        /* History Table */
        .history-table { width: 100%; border-collapse: collapse; font-size: 13px; font-family: monospace; }
        .history-table th { background: #111; color: var(--accent); padding: 12px; text-align: center; position: sticky; top: 0; border-bottom: 1px solid #333; z-index: 2; }
        .history-table td { padding: 10px; border-bottom: 1px solid #222; text-align: center; color: #ccc; }
        .history-table tr:hover td { background: #151515; color: #fff; }

        /* Game UI */
        #game-ui { display: flex; flex-direction: row; justify-content: center; align-items: flex-start; gap: 40px; transform: scale(0.95); transition: 0.5s; }
        @media (max-height: 950px) { #game-ui { transform: scale(0.8); } }
        @media (max-width: 1200px) { #game-ui { transform: scale(0.7); } }

        .stat-box-top { background: #000; border: 1px solid var(--accent); box-shadow: 0 0 5px var(--glow); width: 100px; padding: 10px 0; text-align: center; transition: border-color 0.3s; }
        .stat-label { font-size: 11px; color: var(--accent); font-weight: bold; letter-spacing: 1px; margin-bottom: 4px; text-transform: uppercase; }
        .stat-val { font-size: 20px; font-weight: bold; color: #fff; font-family: monospace; }

        .game-columns { display: flex; align-items: flex-start; gap: 20px; }
        .col-left { display: flex; flex-direction: column; gap: 15px; width: 150px; }
        .col-center { position: relative; }
        .col-right { display: flex; flex-direction: column; width: 150px; }
        
        .main-board-wrap { border: 2px solid var(--accent); background: #000; box-shadow: 0 0 30px var(--glow-strong); position: relative; }
        .garbage-container { width: 15px; height: 600px; background: #111; border: 1px solid #333; position: absolute; left: -25px; overflow: hidden; }
        .garbage-fill { position: absolute; bottom: 0; width: 100%; background: #ff0033; transition: height 0.2s; box-shadow: 0 0 10px #ff0033; }

        #ffa-grid { display: grid; grid-template-rows: repeat(2, auto); grid-auto-flow: column; gap: 15px; margin-left: 20px; }
        .mini-card { display: flex; flex-direction: column; align-items: center; background: #000; border: 1px solid #333; padding: 5px; transition: 0.2s; }
        
        #home-btn { position: fixed; top: 20px; left: 20px; z-index: 2000; padding: 12px 30px; background: #ff0033; color: #fff; border: none; font-weight: 900; cursor: pointer; border-radius: 4px; box-shadow: 0 0 10px rgba(255,0,51,0.5); }
        .hidden { display: none !important; }
        
        /* Floating Text */
        .float-text { position: absolute; left: 50%; transform: translateX(-50%); font-weight: 900; opacity: 0; pointer-events: none; transition: 0.1s; text-align: center; width: 300px; z-index: 50; }
        .action-text { top: 250px; font-size: 36px; color: #fff; letter-spacing: 2px; text-shadow: 0 0 10px #fff; }
        .combo-text { top: 200px; font-size: 28px; color: #ffcc00; text-shadow: 0 0 10px #ffcc00; }
        .b2b-text { top: 160px; font-size: 18px; color: var(--accent); letter-spacing: 2px; }
        .sent-text { top: 350px; font-size: 60px; color: #ff0055; font-weight: 900; text-shadow: 0 0 20px #ff0055; }

        /* Kill Feed */
        #kill-feed { position: absolute; bottom: 20px; left: 20px; width: 350px; display: flex; flex-direction: column; gap: 8px; pointer-events: none; z-index: 100; }
        .feed-msg { background: rgba(255,0,0,0.1); color: #ff5555; padding: 8px 12px; border-left: 4px solid #ff5555; font-family: monospace; font-weight: bold; text-shadow: 0 0 5px #000; animation: fadeFeed 4s forwards; }
        @keyframes fadeFeed { 0% { opacity: 0; transform: translateX(-20px); } 10% { opacity: 1; transform: translateX(0); } 90% { opacity: 1; } 100% { opacity: 0; } }

        /* Custom User Effects */
        .user-john { color: #7851a9 !important; font-family: 'Brush Script MT', cursive; font-size: 1.3em; text-shadow: 0 0 5px gold; }
        .user-bamba { color: #00ffff; text-shadow: 2px 2px 0px #ffff00; animation: electricGlitch 0.2s infinite; display: inline-block; font-weight: 900; }
        @keyframes electricGlitch { 0% { transform: translate(0, 0); } 25% { transform: translate(-1px, 1px); } 50% { transform: translate(1px, -1px); } 75% { transform: translate(0, 1px); } }
        .user-glitch { font-family: 'Courier New', monospace; color: #00ff41; font-weight: 900; display: inline-block; animation: glitchAnim 0.3s infinite; }
        @keyframes glitchAnim { 0% { text-shadow: 2px 0 red, -2px 0 blue; } 50% { text-shadow: -2px 0 blue, 2px 0 red; } 100% { text-shadow: 2px 0 red, -2px 0 blue; } }
        .user-inferno { background: linear-gradient(to top, #ff0000, #ffcc00); -webkit-background-clip: text; color: transparent; font-weight: 900; animation: inferno 1s alternate infinite; }
        @keyframes inferno { from { filter: drop-shadow(0 0 2px orange); } to { filter: drop-shadow(0 -5px 5px red); } }
    </style>
</head>
<!DOCTYPE html>
<html>
<head>
    <title>Student Learning Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --accent: #00ffcc;               
            --glow: rgba(0, 255, 204, 0.2);  
            --glow-strong: rgba(0, 255, 204, 0.4);
            --bg-color: #050505;
            --panel-bg: rgba(10, 10, 10, 0.85);
        }

        /* --- GLOBAL LAYOUT --- */
        body { 
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(circle at center, transparent 0%, #000 90%), 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), 
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px; 
            background-attachment: fixed;
            color: #fff; 
            font-family: 'Segoe UI', sans-serif; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            height: 100vh; margin: 0; overflow: hidden; 
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* --- MENUS --- */
        #menu-container { position: absolute; z-index: 100; background: rgba(0,0,0,0.95); width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        
        .screen { display: none; flex-direction: column; align-items: center; width: 100%; max-width: 1200px; transition: transform 0.3s ease; transform: scale(0.95); }
        .active { display: flex; }
        
        h1 { font-size: 60px; margin-bottom: 30px; letter-spacing: 4px; text-align: center; font-weight: 900; text-transform: uppercase; }
        h1 span { background: linear-gradient(135deg, var(--accent), #fff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 30px var(--glow); animation: titlePulse 3s infinite ease-in-out; }
        @keyframes titlePulse { 0%, 100% { filter: drop-shadow(0 0 10px var(--glow)); } 50% { filter: drop-shadow(0 0 25px var(--accent)); } }

        /* --- STATS GRID (NEW FEATURE) --- */
        .stats-grid-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            width: 100%;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .stat-grid-box {
            background: #111; border: 1px solid #333; border-radius: 4px; padding: 15px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 0 10px rgba(0,0,0,0.5); transition: transform 0.2s;
        }
        .stat-grid-box:hover { transform: scale(1.02); border-color: var(--accent); }
        .stat-grid-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; font-weight: bold; }
        .stat-grid-val { font-size: 28px; font-weight: 900; color: #fff; font-family: monospace; }
        .stat-grid-val.highlight { color: var(--accent); text-shadow: 0 0 15px var(--glow); }

        /* --- UI BOTTOM RIGHT (NEW FEATURE) --- */
        #ui-bottom-right { 
            position: fixed; bottom: 10px; right: 10px; z-index: 190; 
            display: flex; flex-direction: column; align-items: flex-end; gap: 10px; 
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        
        .floating-btn { 
            padding: 12px 20px; background: #000; color: var(--accent); 
            border: 1px solid var(--accent); box-shadow: 0 0 15px var(--glow); 
            font-weight: bold; cursor: pointer; font-family: 'Segoe UI', monospace; 
            width: 140px; text-align: center; text-transform: uppercase; letter-spacing: 1px;
            transition: 0.2s;
        }
        .floating-btn:hover { background: var(--accent); color: #000; }
        
        /* Player List Popup */
        #player-list-popup {
            width: 340px; height: 400px; background: rgba(10,10,10,0.98); 
            border: 1px solid var(--accent); display: none; flex-direction: column; 
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        #pl-header { 
            background: #1a1a1a; padding: 12px; font-weight: bold; 
            border-bottom: 1px solid #333; display: flex; 
            justify-content: space-between; align-items: center; 
            color: var(--accent); letter-spacing: 1px;
        }
        #pl-content { flex: 1; overflow-y: auto; padding: 5px; }
        
        .pl-item { 
            padding: 10px; border-bottom: 1px solid #222; cursor: pointer; 
            transition: 0.2s; display: flex; justify-content: space-between; 
            align-items: center; color: #ccc; 
        }
        .pl-item:hover { background: rgba(0, 255, 204, 0.1); color: #fff; padding-left: 15px; }
        .pl-status-idle { color: #888; font-size: 10px; text-transform: uppercase; }
        .pl-status-busy { color: #ff5555; font-size: 10px; text-transform: uppercase; }
        
        /* Challenge Confirm Screen */
        .challenge-confirm { padding: 20px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        .challenge-title { font-size: 18px; margin-bottom: 20px; color: #fff; }
        .btn-confirm { padding: 10px 30px; margin: 5px; cursor: pointer; border: none; font-weight: bold; font-size: 14px; text-transform: uppercase; }
        .btn-yes { background: var(--accent); color: #000; box-shadow: 0 0 10px var(--glow); }
        .btn-no { background: #333; color: #fff; border: 1px solid #555; }
        .btn-no:hover { background: #ff0033; border-color: #ff0033; }

        /* Chat Box */
        #chat-container { 
            width: 340px; display: none; flex-direction: column; 
            background: rgba(10,10,10,0.98); border: 1px solid var(--accent); 
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        #chat-history { height: 250px; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px; border-bottom: 1px solid #333; }
        #chat-input { padding: 12px; border: none; outline: none; background: #000; color: white; font-family: monospace; }
        .chat-line { margin-bottom: 4px; line-height: 1.4; word-wrap: break-word; }
        .chat-user { font-weight: bold; color: var(--accent); margin-right: 5px; }
        .chat-sys { color: #ffcc00; font-style: italic; }
        .chat-duel { color: #ff00de; font-weight: bold; }

        .chat-badge { 
            position: absolute; top: -8px; right: -8px; 
            background: #ff0033; color: white; border-radius: 50%; 
            width: 24px; height: 24px; font-size: 12px; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: bold; box-shadow: 0 0 10px #ff0033; animation: bounce 0.5s;
        }
        @keyframes bounce { 0% { transform: scale(0); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        /* --- EXISTING UI ELEMENTS --- */
        #duel-overlay { position: absolute; top: 20px; z-index: 150; background: rgba(0,0,0,0.95); border: 2px solid var(--accent); padding: 15px 50px; border-radius: 12px; text-align: center; display: none; box-shadow: 0 0 50px var(--glow); }
        .duel-score { font-size: 50px; font-weight: 900; color: #fff; text-shadow: 0 0 20px var(--accent); letter-spacing: 5px; line-height: 1; }
        .duel-names { font-size: 14px; color: #888; margin-top: 10px; text-transform: uppercase; letter-spacing: 3px; }
        
        .invite-card { background: rgba(0, 255, 204, 0.05); border: 1px solid var(--accent); padding: 15px; margin: 10px 0; font-size: 13px; animation: flashInvite 1.5s infinite alternate; text-align: center; }
        @keyframes flashInvite { 0% { border-color: var(--accent); box-shadow: 0 0 5px var(--glow); } 100% { border-color: #fff; box-shadow: 0 0 20px var(--accent); } }

        .tech-panel { background: var(--panel-bg); border: 1px solid var(--accent); box-shadow: 0 0 20px var(--glow); border-radius: 8px; padding: 30px; display: flex; flex-direction: column; align-items: center; backdrop-filter: blur(10px); }
        .input-std { background: #111; border: 1px solid #333; color: #fff; padding: 15px; font-size: 18px; border-radius: 4px; margin: 10px 0; width: 300px; text-align: center; transition: 0.3s; }
        .input-std:focus { border-color: var(--accent); box-shadow: 0 0 15px var(--glow); outline: none; background: #000; }
        
        .btn { padding: 15px 40px; font-size: 16px; cursor: pointer; border: none; font-weight: 800; border-radius: 4px; margin: 8px; width: 320px; text-transform: uppercase; transition: all 0.2s ease-in-out; box-shadow: 0 4px 15px rgba(0,0,0,0.5); letter-spacing: 1px; position: relative; overflow: hidden; }
        .btn:hover { transform: translateY(-2px) scale(1.02); filter: brightness(1.2); letter-spacing: 3px; box-shadow: 0 0 20px var(--glow); }
        .btn-green { background: #00ffcc; color: #000; } .btn-zen { background: #a29bfe; color: #000; } .btn-apm { background: #ff5555; color: #fff; } .btn-ffa { background: #ff9900; color: #000; } .btn-blue { background: #00a8ff; color: #fff; } .btn-pink { background: #ff00de; color: #fff; }

        #main-split { display: flex; flex-direction: row; gap: 30px; align-items: flex-start; margin-top: 20px; }
        .menu-col { width: 360px; display: flex; flex-direction: column; align-items: center; }
        .user-info { margin-bottom: 20px; font-size: 16px; color: #ccc; text-align: center; width: 100%; line-height: 1.6; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .user-info span { color: #fff; font-weight: bold; font-size: 18px; }
        
        .lb-header-text { color: var(--accent); font-size: 14px; font-weight: bold; text-align: center; margin-bottom: 10px; margin-top: 20px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #333; padding-bottom: 5px; width: 100%; }
        .lb-list { width: 100%; font-family: 'Segoe UI', sans-serif; font-size: 13px; color: #fff; height: 300px; overflow-y: auto; }
        .lb-item { display: flex; justify-content: space-between; padding: 8px 5px; border-bottom: 1px solid #1a1a1a; transition: background 0.2s; align-items: center; }
        .lb-item:hover { background: rgba(255,255,255,0.05); }
        .rank-num { color: #ffcc00; font-weight: bold; margin-right: 5px; } 
        
        /* Stats Page Layout */
        #stats-layout { display: flex; width: 1000px; height: 600px; gap: 20px; }
        #stats-list { width: 300px; background: #050505; border: 1px solid var(--accent); box-shadow: 0 0 15px var(--glow); border-radius: 4px; overflow-y: auto; padding: 10px; }
        #stats-detail { flex: 1; background: #050505; border: 1px solid var(--accent); box-shadow: 0 0 15px var(--glow); border-radius: 4px; padding: 25px; display: flex; flex-direction: column; overflow: hidden; }
        
        .player-item { padding: 15px; cursor: pointer; border-bottom: 1px solid #222; color: #888; font-weight: bold; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .player-item:hover { background: #111; color: #fff; padding-left: 20px; }
        .player-item.selected { background: rgba(0, 255, 204, 0.1); color: var(--accent); border-left: 4px solid var(--accent); }
        .apm-badge { font-size: 11px; background: #222; color: #fff; padding: 3px 8px; border-radius: 4px; border: 1px solid #444; }
        
        /* Tab Bar */
        .tab-bar { display: flex; border-bottom: 1px solid #333; margin-bottom: 20px; width: 100%; }
        .tab-btn { flex: 1; background: none; border: none; padding: 15px; color: #666; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.2s; }
        .tab-btn:hover { color: #fff; }
        .tab-btn.active { color: var(--accent); border-bottom: 3px solid var(--accent); }

        /* History Table */
        .history-table { width: 100%; border-collapse: collapse; font-size: 13px; font-family: monospace; }
        .history-table th { background: #111; color: var(--accent); padding: 12px; text-align: center; position: sticky; top: 0; border-bottom: 1px solid #333; z-index: 2; }
        .history-table td { padding: 10px; border-bottom: 1px solid #222; text-align: center; color: #ccc; }
        .history-table tr:hover td { background: #151515; color: #fff; }

        /* Game UI */
        #game-ui { display: flex; flex-direction: row; justify-content: center; align-items: flex-start; gap: 40px; transform: scale(0.95); transition: 0.5s; }
        @media (max-height: 950px) { #game-ui { transform: scale(0.8); } }
        @media (max-width: 1200px) { #game-ui { transform: scale(0.7); } }

        .stat-box-top { background: #000; border: 1px solid var(--accent); box-shadow: 0 0 5px var(--glow); width: 100px; padding: 10px 0; text-align: center; transition: border-color 0.3s; }
        .stat-label { font-size: 11px; color: var(--accent); font-weight: bold; letter-spacing: 1px; margin-bottom: 4px; text-transform: uppercase; }
        .stat-val { font-size: 20px; font-weight: bold; color: #fff; font-family: monospace; }

        .game-columns { display: flex; align-items: flex-start; gap: 20px; }
        .col-left { display: flex; flex-direction: column; gap: 15px; width: 150px; }
        .col-center { position: relative; }
        .col-right { display: flex; flex-direction: column; width: 150px; }
        
        .main-board-wrap { border: 2px solid var(--accent); background: #000; box-shadow: 0 0 30px var(--glow-strong); position: relative; }
        .garbage-container { width: 15px; height: 600px; background: #111; border: 1px solid #333; position: absolute; left: -25px; overflow: hidden; }
        .garbage-fill { position: absolute; bottom: 0; width: 100%; background: #ff0033; transition: height 0.2s; box-shadow: 0 0 10px #ff0033; }

        #ffa-grid { display: grid; grid-template-rows: repeat(2, auto); grid-auto-flow: column; gap: 15px; margin-left: 20px; }
        .mini-card { display: flex; flex-direction: column; align-items: center; background: #000; border: 1px solid #333; padding: 5px; transition: 0.2s; }
        
        #home-btn { position: fixed; top: 20px; left: 20px; z-index: 2000; padding: 12px 30px; background: #ff0033; color: #fff; border: none; font-weight: 900; cursor: pointer; border-radius: 4px; box-shadow: 0 0 10px rgba(255,0,51,0.5); }
        .hidden { display: none !important; }
        
        /* Floating Text */
        .float-text { position: absolute; left: 50%; transform: translateX(-50%); font-weight: 900; opacity: 0; pointer-events: none; transition: 0.1s; text-align: center; width: 300px; z-index: 50; }
        .action-text { top: 250px; font-size: 36px; color: #fff; letter-spacing: 2px; text-shadow: 0 0 10px #fff; }
        .combo-text { top: 200px; font-size: 28px; color: #ffcc00; text-shadow: 0 0 10px #ffcc00; }
        .b2b-text { top: 160px; font-size: 18px; color: var(--accent); letter-spacing: 2px; }
        .sent-text { top: 350px; font-size: 60px; color: #ff0055; font-weight: 900; text-shadow: 0 0 20px #ff0055; }

        /* Kill Feed */
        #kill-feed { position: absolute; bottom: 20px; left: 20px; width: 350px; display: flex; flex-direction: column; gap: 8px; pointer-events: none; z-index: 100; }
        .feed-msg { background: rgba(255,0,0,0.1); color: #ff5555; padding: 8px 12px; border-left: 4px solid #ff5555; font-family: monospace; font-weight: bold; text-shadow: 0 0 5px #000; animation: fadeFeed 4s forwards; }
        @keyframes fadeFeed { 0% { opacity: 0; transform: translateX(-20px); } 10% { opacity: 1; transform: translateX(0); } 90% { opacity: 1; } 100% { opacity: 0; } }

        /* Custom User Effects */
        .user-john { color: #7851a9 !important; font-family: 'Brush Script MT', cursive; font-size: 1.3em; text-shadow: 0 0 5px gold; }
        .user-bamba { color: #00ffff; text-shadow: 2px 2px 0px #ffff00; animation: electricGlitch 0.2s infinite; display: inline-block; font-weight: 900; }
        @keyframes electricGlitch { 0% { transform: translate(0, 0); } 25% { transform: translate(-1px, 1px); } 50% { transform: translate(1px, -1px); } 75% { transform: translate(0, 1px); } }
        .user-glitch { font-family: 'Courier New', monospace; color: #00ff41; font-weight: 900; display: inline-block; animation: glitchAnim 0.3s infinite; }
        @keyframes glitchAnim { 0% { text-shadow: 2px 0 red, -2px 0 blue; } 50% { text-shadow: -2px 0 blue, 2px 0 red; } 100% { text-shadow: 2px 0 red, -2px 0 blue; } }
        .user-inferno { background: linear-gradient(to top, #ff0000, #ffcc00); -webkit-background-clip: text; color: transparent; font-weight: 900; animation: inferno 1s alternate infinite; }
        @keyframes inferno { from { filter: drop-shadow(0 0 2px orange); } to { filter: drop-shadow(0 -5px 5px red); } }
    </style>
</head>
<script>
    // --- CONSTANTS ---
    const COLS=10, ROWS=20, B_SIZE=30;
    const PIECES=[[[1,1,1,1]],[[1,1],[1,1]],[[0,1,0],[1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]]];
    const COLORS=['#31C7EF','#F7D308','#FF69B4','#EF2029','#42B642','#9D00FF','#EF7921'];
    // SRS OFFSETS (FULL TABLE)
    const OFFSETS_JLSTZ = [[[0,0], [0,0], [0,0], [0,0], [0,0]], [[0,0], [1,0], [1,-1], [0,2], [1,2]],[[0,0], [0,0], [0,0], [0,0], [0,0]], [[0,0], [-1,0], [-1,-1], [0,2], [-1,2]],[[0,0], [0,0], [0,0], [0,0], [0,0]], [[0,0], [1,0], [1,1], [0,-2], [1,-2]],[[0,0], [0,0], [0,0], [0,0], [0,0]], [[0,0], [-1,0], [-1,1], [0,-2], [-1,-2]]];
    const OFFSETS_I = [[[0,0], [-1,0], [2,0], [-1,0], [2,0]], [[0,-1], [0,-1], [0,-1], [0,1], [0,-2]],[[-1,0], [0,0], [0,0], [0,1], [0,-2]], [[0,1], [0,1], [0,1], [0,-1], [0,2]],[[-1,1], [2,1], [-1,1], [2,0], [-1,0]], [[0,1], [0,1], [0,1], [0,-1], [0,2]],[[0,1], [0,1], [0,1], [0,-1], [0,2]], [[0,-1], [0,-1], [0,-1], [0,1], [0,-2]]];
    const KICK_INDEX = { "0_1":0, "1_0":1, "1_2":2, "2_1":3, "2_3":4, "3_2":5, "3_0":6, "0_3":7 };

    // --- STATE ---
    let socket=null, gameActive=false, gameMode='menu', usersCache={};
    let isChatOpen=false, isPLOpen=false, inputLocked=false, isSpectator=false;

    function formatUserHTML(n) {
        if(!n) return 'Guest';
        if(n==='John') return '<span class="user-john">John</span>';
        if(n==='La Bamba') return '<span class="user-bamba">La Bamba</span>';
        if(n==='Jeffrey') return '<span class="user-glitch">Jeffrey</span>';
        if(n==='Jeremy') return '<span class="user-inferno">Jeremy</span>';
        if(n==='Timmy') return '<span class="user-diamond">Timmy</span>';
        return n;
    }

    // --- SETUP & UI ---
    window.onload = function() {
        if(localStorage.getItem('savedUser')) {
            document.getElementById('username').value = localStorage.getItem('savedUser');
            if(localStorage.getItem('savedPass')) document.getElementById('password').value = localStorage.getItem('savedPass');
            attemptLogin();
        }
    }
    function saveCreds() {
        localStorage.setItem('savedUser', document.getElementById('username').value);
        localStorage.setItem('savedPass', document.getElementById('password').value);
    }

    function toggleChat() {
        const c = document.getElementById('chat-container');
        const pl = document.getElementById('player-list-popup');
        const badge = document.getElementById('chat-badge');
        isChatOpen = !isChatOpen;
        if (isChatOpen) {
            c.style.display = 'flex';
            badge.classList.add('hidden');
            document.getElementById('btn-players').style.transform = 'translateY(-270px)';
            if (isPLOpen) pl.style.transform = 'translateY(-270px)';
        } else {
            c.style.display = 'none';
            document.getElementById('btn-players').style.transform = 'translateY(0)';
            if (isPLOpen) pl.style.transform = 'translateY(0)';
        }
    }

    function togglePlayerList() {
        const pl = document.getElementById('player-list-popup');
        isPLOpen = !isPLOpen;
        if (isPLOpen) {
            pl.style.display = 'flex';
            pl.style.transform = isChatOpen ? 'translateY(-270px)' : 'translateY(0)';
        } else {
            pl.style.display = 'none';
        }
    }

    function attemptLogin() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        if(u && p) { if(!socket) connect(); socket.emit('login_attempt', { username: u, password: p }); }
    }

    function connect() {
        socket = io();
        socket.on('login_response', data => {
            if(data.success) {
                document.getElementById('display-user').innerHTML = formatUserHTML(data.username);
                document.getElementById('display-apm').innerText = data.avgAPM;
                navTo('scr-main');
                document.getElementById('btn-chat').classList.remove('hidden');
                document.getElementById('btn-players').classList.remove('hidden');
            } else alert(data.msg);
        });

        // PLAYER LIST & CHALLENGES
        socket.on('player_list_update', list => {
            const content = document.getElementById('pl-content');
            content.innerHTML = '';
            list.forEach(p => {
                if(p.id !== socket.id) {
                    const div = document.createElement('div');
                    div.className = 'pl-item';
                    const st = p.state==='idle' ? '<span class="pl-status-idle">IDLE</span>' : '<span class="pl-status-busy">BUSY</span>';
                    div.innerHTML = `<span>${formatUserHTML(p.name)}</span> ${st}`;
                    div.onclick = () => { if(p.state==='idle') showChallengeConfirm(p.id, p.name); else alert('Player Busy'); };
                    content.appendChild(div);
                }
            });
            if(list.length <= 1) content.innerHTML = '<div style="padding:20px; color:#666; text-align:center;">No other players online.</div>';
        });

        socket.on('leaderboard_update', data => {
            updateLeaderboardDiv('lb-wins', data.wins, 'wins');
            updateLeaderboardDiv('lb-combo', data.combo, 'maxCombo');
        });

        // 10 STAT BOXES & SORTED LIST
        socket.on('receive_all_stats', data => {
            usersCache = data;
            const list = document.getElementById('stats-list');
            list.innerHTML = '';
            // Sort by Avg APM
            const sorted = Object.entries(data).sort(([,a], [,b]) => {
                const avgA = a.gamesPlayed>0 ? a.totalAPM/a.gamesPlayed : 0;
                const avgB = b.gamesPlayed>0 ? b.totalAPM/b.gamesPlayed : 0;
                return avgB - avgA;
            });
            sorted.forEach(([name, u]) => {
                const avg = u.gamesPlayed>0 ? Math.floor(u.totalAPM/u.gamesPlayed) : 0;
                const div = document.createElement('div');
                div.className = 'player-item';
                div.innerHTML = `<span>${formatUserHTML(name)}</span> <span class="apm-badge">${avg} APM</span>`;
                div.onclick = () => {
                    document.querySelectorAll('.player-item').forEach(e => e.classList.remove('selected'));
                    div.classList.add('selected');
                    loadStatsDetail(name, u);
                };
                list.appendChild(div);
            });
        });

        socket.on('receive_challenge', data => {
            const box = document.getElementById('chat-history');
            box.innerHTML += `<div class="invite-card"><strong>⚔️ 1v1 REQUEST</strong><br>From: ${formatUserHTML(data.fromName)}<br><button class="btn btn-green" style="width:100px; padding:5px; margin-top:5px; font-size:12px;" onclick="socket.emit('duel_accept', '${data.fromId}'); this.parentElement.remove();">ACCEPT</button></div>`;
            box.scrollTop = box.scrollHeight;
            if(!isChatOpen) document.getElementById('chat-badge').classList.remove('hidden');
        });

        // GAME EVENTS
        socket.on('match_start', data => {
            gameMode = data.mode;
            document.getElementById('menu-container').style.display = 'none';
            document.getElementById('game-ui').classList.remove('hidden');
            document.getElementById('home-btn').classList.remove('hidden');
            document.getElementById('duel-overlay').style.display = (gameMode==='duel')?'block':'none';
            
            if(gameMode === 'ffa') {
                const grid = document.getElementById('ffa-grid');
                grid.innerHTML = '';
                data.players.forEach(p => {
                    if(p.id !== socket.id) {
                        const d = document.createElement('div');
                        d.className = 'mini-card';
                        d.innerHTML = `<div style="font-size:10px; color:#888;">${formatUserHTML(p.username)}</div><canvas id="cvs_${p.id}" width="120" height="300" style="background:#000; border:1px solid #333;"></canvas>`;
                        grid.appendChild(d);
                    }
                });
            } else if (gameMode === 'duel') {
                document.getElementById('ffa-grid').innerHTML = `<div class="mini-card" style="border-color:#ff0055;"><div style="color:#ff0055; font-weight:bold; font-size:12px; margin-bottom:5px;">OPPONENT</div><canvas id="oppCanvas" width="240" height="600" style="background:black;"></canvas></div>`;
            }
            p1.initRNG(data.seed); p1.reset(); gameActive = true; loop();
        });

        socket.on('receive_chat', d => {
            const h = document.getElementById('chat-history');
            const cls = d.user==='[SYSTEM]' ? 'chat-sys' : (d.user==='[DUEL]'?'chat-duel':'chat-user');
            h.innerHTML += `<div class="chat-line"><span class="${cls}">${formatUserHTML(d.user)}:</span> ${d.text}</div>`;
            h.scrollTop = h.scrollHeight;
            if(!isChatOpen) document.getElementById('chat-badge').classList.remove('hidden');
        });

        socket.on('enemy_board_update', d => {
            let cvs = (gameMode==='duel') ? document.getElementById('oppCanvas') : document.getElementById(`cvs_${d.id}`);
            if(cvs) drawGrid(cvs.getContext('2d'), d.grid);
        });

        socket.on('duel_round_init', d => {
            document.getElementById('duel-score').innerText = `${d.s1} - ${d.s2}`;
            document.getElementById('duel-names').innerHTML = `${formatUserHTML(d.n1)} vs ${formatUserHTML(d.n2)}`;
        });
        
        socket.on('duel_set_over', d => { alert(`SET OVER!\nWinner: ${d.winner}\nScore: ${d.score}`); goHome(); });
        socket.on('elimination', d => {
            const f = document.getElementById('kill-feed');
            f.innerHTML += `<div class="feed-msg">${formatUserHTML(d.username)} eliminated by ${d.killer}</div>`;
            setTimeout(() => { if(f.firstChild) f.firstChild.remove(); }, 4000);
        });
        socket.on('receive_garbage', n => { if((gameMode==='ffa'||gameMode==='duel') && !isSpectator) p1.receiveGarbage(n); });
    }

    // --- UI HELPERS ---
    function navTo(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function goHome() { 
        if(socket) socket.emit('leave_lobby'); 
        gameActive = false; document.getElementById('game-ui').classList.add('hidden'); 
        document.getElementById('home-btn').classList.add('hidden');
        document.getElementById('menu-container').style.display = 'flex'; 
        document.getElementById('duel-overlay').style.display = 'none';
        navTo('scr-main'); 
    }
    
    function showChallengeConfirm(id, name) {
        const content = document.getElementById('pl-content');
        content.innerHTML = `<div class="challenge-confirm"><h3 class="challenge-title">Challenge ${name}?</h3><div style="display:flex;"><button class="btn-confirm btn-yes" onclick="sendChallenge('${id}')">YES</button><button class="btn-confirm btn-no" onclick="socket.emit('player_list_update', []); togglePlayerList()">NO</button></div></div>`;
    }
    function sendChallenge(id) { socket.emit('duel_challenge', id); togglePlayerList(); }

    function updateLeaderboardDiv(id, list, key) {
        const div = document.getElementById(id);
        div.innerHTML = '';
        list.forEach((u, i) => {
            div.innerHTML += `<div class="lb-item"><span><span class="rank-num">#${i+1}</span> ${formatUserHTML(u.name)}</span> <span style="color:#fff;">${u[key]}</span></div>`;
        });
    }

    function loadStatsDetail(name, u) {
        const gen = document.getElementById('view-general');
        const tb = document.getElementById('duel-history-body');
        const gp = u.gamesPlayed || 0;
        const wr = gp > 0 ? ((u.wins/gp)*100).toFixed(1)+'%' : '0%';
        const avgAPM = gp > 0 ? Math.floor(u.totalAPM/gp) : 0;
        const avgSent = gp > 0 ? Math.floor(u.totalSent/gp) : 0;
        const avgRecv = gp > 0 ? Math.floor(u.totalRecv/gp) : 0;

        gen.innerHTML = `<div class="stat-user-title">${formatUserHTML(name)}</div>
            <div class="stats-grid-container">
                <div class="stat-grid-box"><div class="stat-grid-label">WINS</div><div class="stat-grid-val highlight">${u.wins}</div></div>
                <div class="stat-grid-box"><div class="stat-grid-label">GAMES</div><div class="stat-grid-val">${gp}</div></div>
                <div class="stat-grid-box"><div class="stat-grid-label">WIN RATE</div><div class="stat-grid-val">${wr}</div></div>
                <div class="stat-grid-box"><div class="stat-grid-label">BEST APM</div><div class="stat-grid-val highlight">${u.bestAPM}</div></div>
                <div class="stat-grid-box"><div class="stat-grid-label">AVG APM</div><div class="stat-grid-val">${avgAPM}</div></div>
                <div class="stat-grid-box"><div class="stat-grid-label">MAX COMBO</div><div class="stat-grid-val highlight">${u.maxCombo}</div></div>
                <div class="stat-grid-box"><div class="stat-grid-label">TOTAL SENT</div><div class="stat-grid-val">${u.totalSent||0}</div></div>
                <div class="stat-grid-box"><div class="stat-grid-label">AVG SENT</div><div class="stat-grid-val">${avgSent}</div></div>
                <div class="stat-grid-box"><div class="stat-grid-label">TOTAL RECV</div><div class="stat-grid-val">${u.totalRecv||0}</div></div>
                <div class="stat-grid-box"><div class="stat-grid-label">AVG RECV</div><div class="stat-grid-val">${avgRecv}</div></div>
            </div>`;

        tb.innerHTML = '';
        if(u.duelHistory) {
            u.duelHistory.slice().reverse().forEach(h => {
                const col = h.result === 'WIN' ? 'var(--accent)' : '#ff0033';
                tb.innerHTML += `<tr><td style="color:${col}; font-weight:bold;">${h.result}</td><td>${formatUserHTML(h.opponent)}</td><td>${h.score}</td><td>${new Date(h.date).toLocaleDateString()}</td></tr>`;
            });
        }
    }

    function sendChat(e) { if(e.key === 'Enter') { const inp = document.getElementById('chat-input'); if(inp.value.trim() && socket) { socket.emit('send_chat', inp.value.trim()); inp.value = ''; } } }
    function startZen() { gameMode='zen'; gameActive=true; setupGameUI(); p1.reset(); loop(); }
    function startAPMTest() { gameMode='apm'; gameActive=true; setupGameUI(); p1.reset(); loop(); setTimeout(()=>{ gameActive=false; if(socket) socket.emit('submit_stats_manual', {apm:p1.apm}); goHome(); alert("APM TEST FINISHED: "+p1.apm); }, 60000); }
    function joinFFA() { if(socket) socket.emit('join_ffa'); navTo('scr-wait'); }
    function openStats() { socket.emit('request_all_stats'); navTo('scr-stats'); }
    function logOut() { location.reload(); }
    function setupGameUI() { document.getElementById('menu-container').style.display='none'; document.getElementById('game-ui').classList.remove('hidden'); document.getElementById('home-btn').classList.remove('hidden'); }

    // --- GAME ENGINE ---
    class SeededRNG { constructor(s){this.s=s;} next(){this.s=(this.s*9301+49297)%233280;return this.s/233280;}}
    
    class Player {
        constructor() {
            this.ctx=document.getElementById('p1').getContext('2d');
            this.nCtx=document.getElementById('p1-n').getContext('2d');
            this.hCtx=document.getElementById('p1-h').getContext('2d');
            this.grid=Array.from({length:ROWS},()=>Array(COLS).fill(0));
            this.bag=[]; this.queue=[]; this.holdId=null; this.canHold=true;
            this.active=null; this.rng=new SeededRNG(1);
            this.combo=-1; this.b2b=0; this.pendingG=0; this.maxCombo=0;
            this.linesSent=0; this.linesRecv=0; this.startTime=0; this.apm=0;
            this.popAct=document.getElementById('pop-action');
            this.popCmbo=document.getElementById('pop-combo');
            this.popB2B=document.getElementById('pop-b2b');
            this.popSent=document.getElementById('pop-sent');
        }
        initRNG(s){ this.rng = new SeededRNG(s); }
        reset() {
            this.grid.forEach(r=>r.fill(0));
            this.bag=[]; this.queue=[]; this.holdId=null; this.canHold=true;
            this.combo=-1; this.b2b=0; this.pendingG=0; this.linesSent=0; this.linesRecv=0; this.maxCombo=0;
            this.startTime=Date.now();
            for(let i=0; i<5; i++) this.queue.push(this.pull());
            this.spawn();
        }
        pull() {
            if(!this.bag.length) {
                this.bag=[0,1,2,3,4,5,6];
                for(let i=6;i>0;i--){ const j=Math.floor(this.rng.next()*(i+1)); [this.bag[i],this.bag[j]]=[this.bag[j],this.bag[i]]; }
            }
            return this.bag.pop();
        }
        spawn(id) {
            if(id===undefined) { id=this.queue.shift(); this.queue.push(this.pull()); }
            this.active = { id, matrix:PIECES[id], x:3, y:-2, rot:0, color:COLORS[id] };
            this.canHold = true;
            if(this.collide()) this.onDeath();
            this.drawSide(this.nCtx, this.queue);
            this.updateBoard();
        }
        collide(x=this.active.x, y=this.active.y, m=this.active.matrix) {
            for(let r=0; r<m.length; r++) {
                for(let c=0; c<m[r].length; c++) {
                    if(m[r][c]) {
                        let gx = x+c, gy = y+r;
                        if(gx<0 || gx>=COLS || gy>=ROWS) return true;
                        if(gy>=0 && this.grid[gy][gx]) return true;
                    }
                }
            }
            return false;
        }
        rotate() {
            if(!this.active) return;
            const curRot = this.active.rot;
            const nextRot = (curRot + 1) % 4;
            const nextM = this.active.matrix[0].map((_,i) => this.active.matrix.map(r => r[i]).reverse());
            const isI = this.active.id === 0;
            const table = isI ? OFFSETS_I : OFFSETS_JLSTZ;
            const kickIdx = KICK_INDEX[`${curRot}_${nextRot}`] || 0;
            const kicks = table[kickIdx];
            const ox = this.active.x, oy = this.active.y;
            this.active.matrix = nextM; this.active.rot = nextRot;
            for(let k of kicks) {
                this.active.x = ox + k[0];
                this.active.y = oy - k[1];
                if(!this.collide()) { this.updateBoard(); return; }
            }
            this.active.x = ox; this.active.y = oy;
            this.active.rot = curRot;
            this.active.matrix = this.active.matrix[0].map((_,i) => this.active.matrix.map(r => r[i]).reverse()).map(r=>r.reverse()).map(r=>r.reverse());
        }
        move(dir) {
            if(!this.active) return;
            this.active.x += dir;
            if(this.collide()) this.active.x -= dir;
            this.updateBoard();
        }
        drop() {
            if(!this.active) return;
            this.active.y++;
            if(this.collide()) { this.active.y--; this.lock(); }
            this.updateBoard();
        }
        hardDrop() {
            if(!this.active) return;
            while(!this.collide()) this.active.y++;
            this.active.y--;
            this.lock();
        }
        hold() {
            if(!this.canHold || !this.active) return;
            const cur = this.active.id;
            this.canHold = false;
            if(this.holdId === null) { this.holdId = cur; this.spawn(); }
            else { const tmp = this.holdId; this.holdId = cur; this.spawn(tmp); }
            this.drawSide(this.hCtx, [this.holdId]);
        }
        lock() {
            this.active.matrix.forEach((r,y) => r.forEach((v,x) => {
                if(v && this.active.y+y >= 0) this.grid[this.active.y+y][this.active.x+x] = this.active.color;
            }));
            let lines = 0;
            for(let y=ROWS-1; y>=0; y--) {
                if(this.grid[y].every(c => c!==0)) {
                    this.grid.splice(y, 1);
                    this.grid.unshift(Array(COLS).fill(0));
                    lines++; y++;
                }
            }
            if(lines > 0) {
                this.combo++;
                if(this.combo > this.maxCombo) this.maxCombo = this.combo;
                let atk = (lines===4) ? 4 : (lines-1);
                if(lines===4) {
                    this.b2b++;
                    if(this.b2b > 1) { atk++; this.showText(this.popB2B, "B2B"); }
                    this.showText(this.popAct, "QUAD");
                } else {
                    this.b2b = 0;
                    this.showText(this.popAct, lines===1?"SINGLE":lines===2?"DOUBLE":"TRIPLE");
                }
                if(this.combo > 0) {
                    atk += Math.floor(this.combo/2);
                    this.showText(this.popCmbo, this.combo+" COMBO");
                }
                if(this.pendingG > 0) {
                    let diff = Math.min(this.pendingG, atk);
                    this.pendingG -= diff;
                    atk -= diff;
                }
                if(atk > 0) {
                    this.linesSent += atk;
                    this.showText(this.popSent, "+"+atk);
                    if((gameMode==='ffa' || gameMode==='duel') && socket) {
                        socket.emit('send_garbage', { amount: atk });
                    }
                }
            } else {
                this.combo = -1;
                let amt = Math.min(this.pendingG, 5);
                this.pendingG -= amt;
                for(let k=0; k<amt; k++) {
                    const hole = Math.floor(Math.random()*COLS);
                    const row = Array(COLS).fill('#555');
                    row[hole] = 0;
                    this.grid.shift();
                    this.grid.push(row);
                }
            }
            document.getElementById('p1-g').style.height = (this.pendingG*20)+'px';
            this.updateStats();
            this.spawn();
        }
        receiveGarbage(n) { 
            this.pendingG += n; 
            this.linesRecv += n;
            document.getElementById('p1-g').style.height = (this.pendingG*20)+'px';
        }
        onDeath() {
            const stats = { sent: this.linesSent, recv: this.linesRecv, apm: this.apm, maxCombo: this.maxCombo };
            if(gameMode === 'duel') {
                socket.emit('duel_report_loss', stats);
                this.grid.forEach(r=>r.fill(0));
            } else if (gameMode === 'ffa') {
                socket.emit('player_died', stats);
                alert("Eliminated!");
                goHome();
            } else {
                this.reset();
            }
        }
        updateBoard() {
            if((gameMode==='ffa' || gameMode==='duel') && socket) {
                const vis = JSON.parse(JSON.stringify(this.grid));
                this.active.matrix.forEach((r,y)=>r.forEach((v,x)=>{
                    if(v && this.active.y+y>=0) vis[this.active.y+y][this.active.x+x] = this.active.color;
                }));
                socket.emit('update_board', vis);
            }
        }
        updateStats() {
            const mins = (Date.now() - this.startTime) / 60000;
            this.apm = Math.floor(this.linesSent / mins) || 0;
            document.getElementById('s-apm').innerText = this.apm;
            document.getElementById('s-sent').innerText = this.linesSent;
            document.getElementById('s-recv').innerText = this.linesRecv;
            
            const sec = Math.floor((Date.now() - this.startTime)/1000);
            const m = Math.floor(sec/60).toString().padStart(2,'0');
            const s = (sec%60).toString().padStart(2,'0');
            document.getElementById('s-time').innerText = `${m}:${s}`;
        }
        showText(el, txt) {
            el.innerText = txt; el.style.opacity = 1; el.style.top = "200px";
            setTimeout(() => { el.style.opacity = 0; el.style.top = "150px"; }, 800);
        }
        draw() {
            this.ctx.fillStyle = '#000'; this.ctx.fillRect(0,0,240,600);
            this.grid.forEach((r,y) => r.forEach((v,x) => {
                if(v) { this.ctx.fillStyle = v; this.ctx.fillRect(x*24, y*30, 23, 29); }
            }));
            if(this.active) {
                this.ctx.fillStyle = this.active.color;
                this.active.matrix.forEach((r,y) => r.forEach((v,x) => {
                    if(v) this.ctx.fillRect((this.active.x+x)*24, (this.active.y+y)*30, 23, 29);
                }));
            }
        }
        drawSide(ctx, q) {
            ctx.fillStyle='#000'; ctx.fillRect(0,0,100,400);
            q.slice(0,4).forEach((id, i) => {
                if(id!==null && id!==undefined) {
                    ctx.fillStyle=COLORS[id];
                    PIECES[id].forEach((r,y)=>r.forEach((v,x)=>{
                        if(v) ctx.fillRect(10+x*20, i*70+y*20, 19, 19);
                    }));
                }
            });
        }
    }

    const p1 = new Player();
    
    document.addEventListener('keydown', e => {
        if(!gameActive) return;
        if(e.code === 'ArrowLeft') p1.move(-1);
        if(e.code === 'ArrowRight') p1.move(1);
        if(e.code === 'ArrowUp') p1.rotate();
        if(e.code === 'ArrowDown') p1.drop();
        if(e.code === 'Space') p1.hardDrop();
        if(e.code === 'ShiftLeft') p1.hold();
    });

    let lastTime = 0;
    function loop(t=0) {
        const dt = t - lastTime;
        if(dt > 500) { p1.drop(); lastTime = t; }
        p1.draw();
        if(gameActive) requestAnimationFrame(loop);
    }

    function drawGrid(ctx, grid) {
        ctx.fillStyle='#000'; ctx.fillRect(0,0,240,600);
        if(grid) {
            grid.forEach((r,y)=>r.forEach((v,x)=>{
                if(v) { ctx.fillStyle=v; ctx.fillRect(x*24, y*30, 23, 29); }
            }));
        }
    }
</script>
</body>
</html>
