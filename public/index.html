<!DOCTYPE html>
<html>
<head>
    <title>Student Learning Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --accent: #00ffcc; --glow: rgba(0, 255, 204, 0.2); }
        body { background-color: #050505; color: #fff; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        
        /* Effects */
        .user-john { color: #7851a9 !important; font-family: 'Brush Script MT', cursive; text-shadow: 0 0 5px gold; animation: goldPulse 2s infinite alternate; }
        @keyframes goldPulse { 0% { text-shadow: 0 0 5px gold; } 100% { text-shadow: 0 0 20px gold; } }
        .user-bamba { font-family: 'Courier New', monospace; font-weight: 900; color: #00ffff; text-shadow: 2px 2px 0px #ffff00; display: inline-block; animation: electricGlitch 0.2s infinite; }
        @keyframes electricGlitch { 0% { transform: translate(0,0); text-shadow: 2px 2px 0 #ff0; color: #0ff; } 50% { transform: translate(2px,-1px); text-shadow: 0 0 10px #fff; color: #fff; } 100% { transform: translate(0,0); } }

        /* UI Containers */
        #menu-container { position: absolute; z-index: 100; background: rgba(0,0,0,0.95); width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .screen { display: none; flex-direction: column; align-items: center; width: 100%; max-width: 1200px; transform: scale(0.95); }
        .active { display: flex; }
        .btn { padding: 15px 40px; font-size: 16px; cursor: pointer; border: none; font-weight: 800; border-radius: 4px; margin: 8px; width: 300px; text-transform: uppercase; background: #333; color: #fff; transition: 0.2s; }
        .btn:hover { transform: scale(1.02); filter: brightness(1.2); }
        .btn-green { background: #00ffcc; color: #000; }
        
        /* Game Grid */
        #game-ui { display: flex; flex-direction: row; justify-content: center; align-items: flex-start; gap: 40px; transform: scale(0.9); }
        .game-columns { display: flex; align-items: flex-start; gap: 15px; }
        canvas { display: block; background: #000; border: 1px solid #333; }
        .main-board-wrap { border: 2px solid var(--accent); box-shadow: 0 0 20px var(--glow); position: relative; }
        
        #ffa-grid { display: grid; grid-template-rows: repeat(2, auto); grid-auto-flow: column; gap: 15px; }
        .mini-card { display: flex; flex-direction: column; align-items: center; background: #000; border: 1px solid #333; padding: 5px; }
        
        .hidden { display: none !important; }
        
        /* Chat */
        #chat-container { position: fixed; bottom: 0; right: 0; width: 320px; z-index: 200; display: flex; flex-direction: column; }
        #chat-history { height: 200px; background: rgba(0,0,0,0.9); overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px; }
        #chat-input { padding: 10px; border: none; }
    </style>
</head>
<body>
    <div id="menu-container">
        <div id="scr-login" class="screen active">
            <h1>PROJECT <span>A</span></h1>
            <input id="username" class="input-std" placeholder="USERNAME" style="padding:10px; margin:10px;">
            <input id="password" type="password" class="input-std" placeholder="PASSWORD" style="padding:10px; margin:10px;">
            <button class="btn btn-green" onclick="doLogin()">LOGIN</button>
        </div>
        <div id="scr-main" class="screen">
            <h1>LOBBY</h1>
            <div id="user-display" style="color:#fff; margin-bottom:20px; font-size:20px;"></div>
            <button class="btn btn-green" onclick="joinGame()">JOIN FFA</button>
        </div>
        <div id="scr-wait" class="screen"><h2>WAITING FOR PLAYERS...</h2></div>
    </div>

    <div id="game-ui" class="hidden">
        <div id="p1-root">
            <div class="game-columns">
                <div class="col-left">
                    <canvas id="p1-h" width="100" height="100"></canvas>
                    <div style="color:#fff; margin-top:10px;">SENT: <span id="s-sent">0</span></div>
                </div>
                <div class="main-board-wrap">
                    <canvas id="p1" width="200" height="400"></canvas>
                </div>
                <div class="col-right">
                    <canvas id="p1-n" width="100" height="300"></canvas>
                </div>
            </div>
        </div>
        <div id="ffa-grid"></div>
    </div>

    <div id="chat-container">
        <div id="chat-history"></div>
        <input id="chat-input" placeholder="Chat..." onkeydown="if(event.key==='Enter')sendChat()">
    </div>

    <script>
        const socket = io();
        const COLORS = [null, '#31C7EF','#F7D308','#FF69B4','#EF2029','#42B642','#9D00FF','#EF7921', '#555'];
        let myUser = "";

        // --- AUTH ---
        function doLogin() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            socket.emit('login_attempt', {username:u, password:p});
        }
        
        socket.on('login_response', d => {
            if(d.success) {
                myUser = d.username;
                document.getElementById('user-display').innerHTML = formatUser(myUser);
                nav('scr-main');
            } else alert(d.msg);
        });

        // --- GAME JOINING ---
        function joinGame() {
            socket.emit('join_ffa');
            nav('scr-wait');
        }

        socket.on('start_countdown', n => {
            document.querySelector('#scr-wait h2').innerText = "STARTING IN " + n;
        });

        // --- RENDERER (Server Authority) ---
        socket.on('gamestate', (players) => {
            nav('hidden'); // Hide menus
            document.getElementById('game-ui').classList.remove('hidden');
            
            const myState = players.find(p => p.username === myUser);
            const others = players.filter(p => p.username !== myUser);

            // DRAW SELF
            if (myState) {
                drawBoard(document.getElementById('p1'), myState);
                drawQueue(document.getElementById('p1-n'), myState.next);
                drawHold(document.getElementById('p1-h'), myState.hold);
                document.getElementById('s-sent').innerText = myState.stats.sent;
            }

            // DRAW ENEMIES
            const grid = document.getElementById('ffa-grid');
            // Sync DOM elements
            let cards = Array.from(grid.children);
            if (cards.length !== others.length) {
                grid.innerHTML = '';
                others.forEach(p => {
                    const d = document.createElement('div');
                    d.className = 'mini-card';
                    d.innerHTML = `<span>${formatUser(p.username)}</span><canvas id="cvs_${p.id}" width="100" height="200"></canvas>`;
                    grid.appendChild(d);
                });
            }
            
            // Draw Enemy Boards
            others.forEach(p => {
                const cvs = document.getElementById(`cvs_${p.id}`);
                if(cvs) drawBoard(cvs, p, 0.5); // 0.5 scale for mini
            });
        });

        // --- DRAWING HELPERS ---
        function drawBoard(cvs, state, scale=1) {
            const ctx = cvs.getContext('2d');
            const W = cvs.width, H = cvs.height;
            const BS = 20 * scale; // Block Size
            
            ctx.fillStyle = '#000'; ctx.fillRect(0,0,W,H);
            
            if (!state.alive) {
                ctx.fillStyle = '#300'; ctx.fillRect(0,0,W,H);
            }

            // Draw Grid (Buffer hidden by slicing index 20)
            const visibleGrid = state.grid.slice(20); 
            visibleGrid.forEach((row, y) => {
                row.forEach((val, x) => {
                    if (val > 0) {
                        ctx.fillStyle = COLORS[val];
                        ctx.fillRect(x*BS, y*BS, BS, BS);
                    }
                });
            });

            // Draw Active Piece
            if (state.active && state.alive) {
                const { matrix, pos, id } = state.active;
                const visibleY = pos.y - 20; // Adjust for hidden buffer
                ctx.fillStyle = COLORS[id+1];
                matrix.forEach((row, y) => {
                    row.forEach((v, x) => {
                        if (v && (visibleY + y) >= 0) {
                            ctx.fillRect((pos.x + x)*BS, (visibleY + y)*BS, BS, BS);
                        }
                    });
                });
            }
        }

        function drawQueue(cvs, queue) {
            const ctx = cvs.getContext('2d');
            ctx.fillStyle = '#000'; ctx.fillRect(0,0,cvs.width,cvs.height);
            queue.forEach((id, i) => {
                ctx.fillStyle = COLORS[id+1];
                ctx.fillRect(30, i*50 + 10, 30, 30); // Simplified preview
            });
        }

        function drawHold(cvs, id) {
            const ctx = cvs.getContext('2d');
            ctx.fillStyle = '#000'; ctx.fillRect(0,0,cvs.width,cvs.height);
            if(id !== null) {
                ctx.fillStyle = COLORS[id+1];
                ctx.fillRect(25, 25, 50, 50);
            }
        }

        // --- INPUTS (Send to Server) ---
        window.addEventListener('keydown', e => {
            const map = { 'ArrowLeft':'left', 'ArrowRight':'right', 'ArrowUp':'rotate', 'ArrowDown':'soft', ' ':'hard', 'Shift':'hold' };
            if (map[e.key]) socket.emit('input', map[e.key]);
        });

        // --- UTILS ---
        function nav(id) {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            const el = document.getElementById(id);
            if(el) el.style.display = 'flex';
        }

        function formatUser(name) {
            if(name === 'John') return '<span class="user-john">John</span>';
            if(name === 'La BambaüÉè') return '<span class="user-bamba">La BambaüÉè</span>';
            return name;
        }

        function sendChat() {
            const i = document.getElementById('chat-input');
            socket.emit('send_chat', i.value);
            i.value = '';
        }
        socket.on('receive_chat', d => {
            const h = document.getElementById('chat-history');
            h.innerHTML += `<div><b>${formatUser(d.user)}:</b> ${d.text}</div>`;
            h.scrollTop = h.scrollHeight;
        });
    </script>
</body>
</html>
