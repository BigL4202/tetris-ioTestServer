<!DOCTYPE html>
<html>
<head>
    <title>Student Learning Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --accent: #00ffcc; --bg-color: #050505; }
        body { background: var(--bg-color); color: #fff; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        
        #menu-container { position: absolute; z-index: 100; background: rgba(0,0,0,0.95); width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .screen { display: none; flex-direction: column; align-items: center; width: 100%; max-width: 950px; }
        .active { display: flex; }
        
        h1 { font-size: 60px; margin-bottom: 30px; font-weight: 900; letter-spacing: 4px; }
        h1 span { color: var(--accent); }

        .tech-panel { background: rgba(10,10,10,0.8); border: 1px solid var(--accent); padding: 30px; border-radius: 8px; }
        .input-std { background: #111; border: 1px solid #333; color: #fff; padding: 12px; margin: 10px 0; width: 300px; text-align: center; font-size: 18px; }
        
        .btn { padding: 15px 40px; font-size: 16px; cursor: pointer; border: none; font-weight: 800; margin: 8px; width: 300px; transition: 0.2s; }
        .btn:hover { transform: scale(1.02); filter: brightness(1.2); }
        .btn-green { background: #00ffcc; color: #000; }
        .btn-zen { background: #a29bfe; color: #000; }
        .btn-apm { background: #ff5555; color: #fff; }
        .btn-ffa { background: #ff9900; color: #000; }
        .btn-mixtape { background: #32ff7e; color: #000; }
        .btn-blue { background: #00a8ff; color: #fff; }
        .btn-gray { background: #444; color: #fff; }

        #main-split { display: flex; gap: 40px; margin-top: 10px; }
        .menu-left, .menu-right { width: 340px; display: flex; flex-direction: column; }
        .user-info { text-align: center; margin-bottom: 20px; color: #ccc; border-bottom: 1px solid #333; padding-bottom: 15px; }
        
        .lb-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #222; font-size: 13px; }
        
        /* PASSIVE SELECT */
        .passive-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 100%; margin-bottom: 20px; }
        .passive-card { background: #111; border: 1px solid #333; height: 80px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px; font-weight: bold; color: #666; }
        .passive-card.selected { border-color: var(--accent); background: rgba(0,255,204,0.1); color: var(--accent); }
        .passive-info-box { background: #111; border: 1px solid var(--accent); padding: 15px; margin-bottom: 20px; width: 100%; box-sizing: border-box; }
        .p-pro { color: #32ff7e; font-weight: bold; } .p-con { color: #ff5555; font-weight: bold; }

        /* GAME UI */
        .game-area { display: flex; gap: 40px; margin-top: 20px; transform: scale(0.9); }
        @media (max-width: 1200px) { .game-area { transform: scale(0.65); margin-top: 0; } }

        .game-columns { display: flex; gap: 15px; }
        .col-left, .col-right { display: flex; flex-direction: column; width: 150px; gap: 15px; }
        
        .box-container { background: #000; border: 1px solid var(--accent); display: flex; flex-direction: column; align-items: center; padding-bottom: 5px; }
        .box-header { width: 100%; text-align: center; color: var(--accent); font-size: 12px; font-weight: bold; padding: 5px 0; }
        
        .main-board-wrap { border: 2px solid var(--accent); background: #000; position: relative; }
        canvas { display: block; }

        .stats-header { display: flex; gap: 15px; margin-bottom: 10px; }
        .stat-box-top { background: #000; border: 1px solid var(--accent); width: 100px; text-align: center; padding: 5px 0; }
        .stat-val { font-size: 18px; font-weight: bold; }

        #sniper-mag { margin-top: 10px; width: 60px; height: 150px; border: 2px solid #444; background: #111; display: none; flex-direction: column-reverse; padding: 2px; }
        .mag-bullet { width: 100%; height: 9%; background: #ffcc00; margin-bottom: 1%; }
        #hold-ind { font-size: 10px; color: #32ff7e; text-align: center; margin-top: 5px; display: none; font-weight: bold; }

        .overlay { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 150; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .hidden { display: none !important; }
        #cnt-txt { font-size: 120px; font-weight: 900; }
        
        #results-table { margin-top: 20px; font-family: monospace; font-size: 20px; width: 600px; border-collapse: collapse; }
        #results-table th { color: var(--accent); border-bottom: 2px solid #fff; padding: 10px; }
        #results-table td { color: #fff; border-bottom: 1px solid #444; padding: 10px; text-align: center; }

        #chat-container { position: fixed; bottom: 0; right: 0; width: 320px; background: rgba(0,0,0,0.9); border: 1px solid #333; display: flex; flex-direction: column; }
        #chat-history { height: 200px; overflow-y: auto; padding: 10px; font-size: 12px; font-family: monospace; }
        #chat-input { padding: 10px; border: none; background: #fff; color: #000; }
    </style>
</head>
<body>
    <div id="menu-container">
        <div id="scr-login" class="screen active">
            <h1>PROJECT <span>A</span></h1>
            <input type="text" id="username" class="input-std" placeholder="USERNAME">
            <input type="password" id="password" class="input-std" placeholder="PASSWORD">
            <button class="btn btn-green" onclick="attemptLogin()">LOGIN</button>
        </div>

        <div id="scr-main" class="screen">
            <h1>PROJECT <span>A</span></h1>
            <div id="main-split">
                <div class="menu-left tech-panel">
                    <div class="user-info">User: <span id="disp-user">Guest</span> | Wins: <span id="disp-wins">0</span></div>
                    <button class="btn btn-zen" onclick="startZen()">ZEN MODE</button>
                    <button class="btn btn-apm" onclick="startAPM()">APM TEST</button>
                    <button class="btn btn-ffa" onclick="joinFFA()">ONLINE FFA</button>
                    <button class="btn btn-mixtape" onclick="openPassive()">MUTATOR MADNESS</button>
                    <button class="btn btn-blue" onclick="openStats()">STATS</button>
                    <button class="btn btn-gray" onclick="location.reload()">LOGOUT</button>
                </div>
                <div class="menu-right tech-panel">
                    <div class="lb-header-text">LEADERBOARD</div>
                    <div id="lb-wins" class="lb-list">Loading...</div>
                </div>
            </div>
        </div>

        <div id="scr-passive" class="screen">
            <h2 style="color: var(--accent);">CHOOSE ABILITY</h2>
            <div class="passive-info-box">
                <div id="p-title" class="p-title">SELECT</div>
                <div id="p-desc" style="color:#ccc; font-size:14px; margin-bottom:10px;"></div>
                <div style="display:flex; justify-content:space-between;">
                    <div id="p-pro" class="p-pro"></div><div id="p-con" class="p-con"></div>
                </div>
            </div>
            <div class="passive-grid">
                <div class="passive-card" onclick="selPass('double_hold')">EXTRA HOLD</div>
                <div class="passive-card" onclick="selPass('sniper')">SNIPER</div>
                <div class="passive-card locked">LOCKED</div>
                <div class="passive-card locked">LOCKED</div>
                <div class="passive-card locked">LOCKED</div>
                <div class="passive-card locked">LOCKED</div>
                <div class="passive-card locked">LOCKED</div>
                <div class="passive-card locked">LOCKED</div>
            </div>
            <button id="btn-conf" class="btn btn-mixtape" style="opacity:0.5;" onclick="joinMadness()">CONFIRM</button>
            <button class="btn btn-gray" onclick="nav('scr-main')">BACK</button>
        </div>

        <div id="scr-stats" class="screen">
            <h2 style="color: var(--accent);">STATS</h2>
            <div id="stats-content" style="width:600px; height:400px; background:#111; overflow:auto; padding:20px;"></div>
            <button class="btn btn-gray" onclick="nav('scr-main')">BACK</button>
        </div>

        <div id="scr-wait" class="screen">
            <h2 id="wait-msg">JOINING...</h2>
            <button class="btn btn-gray" onclick="goHome()">CANCEL</button>
        </div>
    </div>

    <div id="ov-cnt" class="overlay hidden"><div id="cnt-txt">3</div></div>
    <div id="ov-res" class="overlay hidden">
        <h1 style="color: var(--accent);">RESULTS</h1>
        <table id="results-table">
            <thead><tr><th>#</th><th>PLAYER</th><th>SURVIVED</th><th>SENT</th></tr></thead>
            <tbody id="res-body"></tbody>
        </table>
        <div style="margin-top:20px; color:#888;">Next in <span id="res-timer">5</span>s</div>
    </div>

    <div id="chat-container" class="hidden">
        <div id="chat-history"></div>
        <input id="chat-input" placeholder="Chat..." onkeydown="sendChat(event)">
    </div>

    <div id="game-ui" class="game-area hidden">
        <div class="stats-header">
            <div class="stat-box-top"><div class="stat-label">TIME</div><div id="s-time" class="stat-val">00:00</div></div>
            <div class="stat-box-top"><div class="stat-label">PPS</div><div id="s-pps" class="stat-val">0.00</div></div>
            <div class="stat-box-top"><div class="stat-label">APM</div><div id="s-apm" class="stat-val">0</div></div>
        </div>
        <div class="game-columns">
            <div class="col-left">
                <div class="box-container"><div class="box-header">HOLD</div><canvas id="cvs-h" width="150" height="160"></canvas><div id="hold-ind"></div></div>
                <div id="sniper-mag"></div>
                <div style="flex:1"></div>
                <div class="box-container box-stat-side"><div class="box-header">SENT</div><div id="s-sent" class="stat-val">0</div></div>
                <div class="box-container box-stat-side"><div class="box-header">RECV</div><div id="s-recv" class="stat-val">0</div></div>
            </div>
            <div class="col-center">
                <div class="garbage-container"><div id="g-bar" class="garbage-fill"></div></div>
                <div class="main-board-wrap"><canvas id="cvs-b" width="120" height="900"></canvas></div>
            </div>
            <div class="col-right">
                <div class="box-container"><div class="box-header">NEXT</div><canvas id="cvs-n" width="150" height="400"></canvas></div>
                <div id="ffa-grid"></div>
            </div>
        </div>
    </div>
    <script>
        const PASSIVES = {
            'double_hold': { name:"EXTRA HOLD", desc:"Gain a second Hold slot (Ctrl/Tab).", pro:"• 2 Inventory Slots", con:"• Slower combo scaling" },
            'sniper': { name:"SNIPER", desc:"Clear 1-3 lines to build AMMO. Clear Quad to fire 1.5x damage.", pro:"• Massive Quad Damage", con:"• Small clears send 0" }
        };
        const PIECES=[[[1,1,1,1]],[[1,1],[1,1]],[[0,1,0],[1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]]];
        const COLORS=['#31C7EF','#F7D308','#FF69B4','#EF2029','#42B642','#9D00FF','#EF7921'];
        
        let socket, gameMode='zen', activeMutator=null, selPassive=null, inputLocked=false;
        let p1; 

        // --- NAVIGATION ---
        function nav(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function goHome() { 
            if(socket) socket.emit('leave_lobby'); 
            document.getElementById('game-ui').classList.add('hidden');
            document.getElementById('menu-container').style.display='flex';
            document.querySelectorAll('.overlay').forEach(o=>o.classList.add('hidden'));
            nav('scr-main'); 
        }

        function attemptLogin() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if(!socket) connect();
            socket.emit('login_attempt', {username:u, password:p});
        }

        // --- GAME MODES ---
        function startZen() { if(socket)socket.emit('leave_lobby'); gameMode='zen'; activeMutator=null; startGameUI(); p1.reset(); loop(); }
        function startAPM() { if(socket)socket.emit('leave_lobby'); gameMode='apm'; activeMutator=null; startGameUI(); p1.reset(); loop(); setTimeout(goHome, 60000); }
        
        function joinFFA() { 
            nav('scr-wait'); 
            document.getElementById('wait-msg').innerText="JOINING FFA..."; 
            socket.emit('join_ffa'); 
        }

        function openPassive() { nav('scr-passive'); selPass('double_hold'); }
        function selPass(id) {
            selPassive = id;
            const p = PASSIVES[id];
            document.getElementById('p-title').innerText = p.name;
            document.getElementById('p-desc').innerText = p.desc;
            document.getElementById('p-pro').innerText = p.pro;
            document.getElementById('p-con').innerText = p.con;
            document.querySelectorAll('.passive-card').forEach(e=>e.classList.remove('selected'));
            document.getElementById('btn-conf').style.opacity = '1';
        }
        function joinMadness() {
            nav('scr-wait');
            document.getElementById('wait-msg').innerText="JOINING MUTATOR...";
            socket.emit('join_madness', selPassive);
        }

        function startGameUI() {
            document.getElementById('menu-container').style.display='none';
            document.getElementById('game-ui').classList.remove('hidden');
            document.getElementById('chat-container').classList.remove('hidden');
            
            // Reset Mutator UI
            document.getElementById('hold-ind').style.display = 'none';
            document.getElementById('sniper-mag').style.display = 'none';
            
            if(activeMutator === 'double_hold') {
                document.getElementById('hold-ind').style.display = 'block';
                document.getElementById('hold-ind').innerText = "EXTRA HOLD ACTIVE";
            }
            if(activeMutator === 'sniper') {
                document.getElementById('sniper-mag').style.display = 'flex';
            }
        }

        // --- SOCKETS ---
        function connect() {
            socket = io();
            
            socket.on('login_response', d => {
                if(d.success) {
                    nav('scr-main');
                    document.getElementById('disp-user').innerText = d.username;
                    document.getElementById('disp-wins').innerText = d.wins;
                } else alert(d.msg);
            });

            // THIS WAS MISSING - FIXES THE STUCK SCREEN
            socket.on('lobby_update', d => {
                document.getElementById('wait-msg').innerText = `WAITING FOR PLAYERS (${d.count}/2)...`;
            });

            socket.on('start_countdown', d => {
                if(gameMode==='zen'||gameMode==='apm') return;
                startGameUI();
                const ov = document.getElementById('ov-cnt');
                ov.classList.remove('hidden');
                let n = d.duration;
                const txt = document.getElementById('cnt-txt');
                txt.innerText = n;
                const iv = setInterval(() => {
                    n--;
                    if(n>0) txt.innerText = n;
                    else { clearInterval(iv); ov.classList.add('hidden'); }
                }, 1000);
            });

            socket.on('match_start', d => {
                gameMode = d.mode;
                if(d.mode === 'madness') {
                    // Find my passive
                    const me = d.players.find(p => p.id === socket.id);
                    activeMutator = me ? me.passive : null;
                } else {
                    activeMutator = null;
                }
                startGameUI(); // Just in case
                p1.reset();
                setupEnemies(d.players);
                loop();
            });

            socket.on('receive_garbage', n => { if(gameMode!=='zen') p1.recv(n); });
            socket.on('enemy_board_update', d => drawEnemy(d.id, d.grid));
            socket.on('match_summary', res => showResults(res));
            socket.on('lobby_reset', () => { document.getElementById('ov-res').classList.add('hidden'); if(gameMode!=='zen') goHome(); });
        }

        function setupEnemies(players) {
            const g = document.getElementById('ffa-grid');
            g.innerHTML = '';
            players.forEach(p => {
                if(p.id !== socket.id) {
                    const d = document.createElement('div');
                    d.className = 'mini-card';
                    d.innerHTML = `<div style="font-size:10px;color:#888">${p.username}</div><canvas id="cvs_${p.id}" width="80" height="520"></canvas>`;
                    g.appendChild(d);
                }
            });
        }

        function drawEnemy(id, grid) {
            const c = document.getElementById(`cvs_${id}`);
            if(!c) return;
            const ctx = c.getContext('2d');
            ctx.fillStyle = '#000'; ctx.fillRect(0,0,80,520);
            grid.forEach((row, y) => row.forEach((v, x) => {
                if(v) { ctx.fillStyle=v; ctx.fillRect(x*20, y*20, 19, 19); }
            }));
        }

        function showResults(res) {
            const ov = document.getElementById('ov-res');
            ov.classList.remove('hidden');
            const tb = document.getElementById('res-body');
            tb.innerHTML = '';
            res.forEach(r => {
                tb.innerHTML += `<tr><td class="${r.place===1?'rank-1':''}">${r.place}</td><td>${r.username}</td><td>${r.durationStr}</td><td>${r.sent}</td></tr>`;
            });
            let t = 5;
            const timer = document.getElementById('res-timer');
            const iv = setInterval(() => { t--; timer.innerText=t; if(t<=0) clearInterval(iv); }, 1000);
        }

        function sendChat(e) {
            if(e.key === 'Enter') {
                const i = document.getElementById('chat-input');
                if(i.value && socket) { socket.emit('send_chat', i.value); i.value=''; }
            }
        }

        // --- GAME ENGINE ---
        class Player {
            constructor() {
                this.ctx = document.getElementById('cvs-b').getContext('2d');
                this.hCtx = document.getElementById('cvs-h').getContext('2d');
                this.nCtx = document.getElementById('cvs-n').getContext('2d');
                this.grid = Array.from({length:30}, ()=>Array(4).fill(0));
                this.queue = []; this.bag = [];
                this.ammo = 0;
            }
            
            reset() {
                this.grid.forEach(r => r.fill(0));
                this.bag = []; this.queue = [];
                this.holdId = null; this.hold2 = null;
                this.canHold = true; this.ammo = 0;
                this.combo = -1; this.sent = 0; this.recvTotal = 0;
                this.updateMag();
                for(let i=0; i<4; i++) this.queue.push(this.pull());
                this.spawn();
            }

            pull() {
                if(!this.bag.length) {
                    this.bag = [0,1,2,3,4,5,6];
                    for(let i=6; i>0; i--) { const j=Math.floor(Math.random()*(i+1)); [this.bag[i],this.bag[j]]=[this.bag[j],this.bag[i]]; }
                }
                return this.bag.pop();
            }

            spawn() {
                this.active = { 
                    id: this.queue.shift(), 
                    pos: {x:0, y:-1}, 
                    rot: 0 
                };
                this.active.mat = PIECES[this.active.id];
                this.active.col = COLORS[this.active.id];
                this.queue.push(this.pull());
                this.draw(); this.drawSide();
                
                if(this.collide()) { /* Game Over Logic handled by server usually */ }
                if(socket) socket.emit('update_board', this.grid);
            }

            collide(ox=0, oy=0, mat=this.active.mat) {
                for(let y=0; y<mat.length; y++) {
                    for(let x=0; x<mat[y].length; x++) {
                        if(mat[y][x]) {
                            const nx = this.active.pos.x + x + ox;
                            const ny = this.active.pos.y + y + oy;
                            if(nx < 0 || nx >= 4 || ny >= 30 || (ny>=0 && this.grid[ny][nx])) return true;
                        }
                    }
                }
                return false;
            }

            move(dir) {
                if(!this.collide(dir, 0)) {
                    this.active.pos.x += dir;
                    this.draw();
                }
            }

            rotate() {
                const N = this.active.mat.length;
                const next = this.active.mat[0].map((_, c) => this.active.mat.map(r => r[c]).reverse());
                if(!this.collide(0,0,next)) this.active.mat = next;
                else if(!this.collide(1,0,next)) { this.active.pos.x+=1; this.active.mat=next; }
                else if(!this.collide(-1,0,next)) { this.active.pos.x-=1; this.active.mat=next; }
                this.draw();
            }

            hold(slot) {
                if(!this.canHold) return;
                const cur = this.active.id;
                
                if(slot === 1) {
                    if(this.holdId === null) { this.holdId=cur; this.spawn(); }
                    else { const t=this.holdId; this.holdId=cur; this.active.id=t; this.active.mat=PIECES[t]; this.active.col=COLORS[t]; this.active.pos={x:0,y:-1}; }
                } else if(slot === 2 && activeMutator==='double_hold') {
                    if(this.hold2 === null) { this.hold2=cur; this.spawn(); }
                    else { const t=this.hold2; this.hold2=cur; this.active.id=t; this.active.mat=PIECES[t]; this.active.col=COLORS[t]; this.active.pos={x:0,y:-1}; }
                }
                this.canHold = false;
                this.drawSide();
            }

            hardDrop() {
                while(!this.collide(0,1)) this.active.pos.y++;
                this.lock();
            }

            lock() {
                this.active.mat.forEach((row, y) => row.forEach((v, x) => {
                    if(v) {
                        const ny = this.active.pos.y + y;
                        if(ny >= 0) this.grid[ny][this.active.pos.x + x] = this.active.col;
                    }
                }));
                this.sweep();
                this.canHold = true;
                this.spawn();
            }

            sweep() {
                let lines = 0;
                for(let y=29; y>=0; y--) {
                    if(this.grid[y].every(c => c !== 0)) {
                        this.grid.splice(y, 1);
                        this.grid.unshift(Array(4).fill(0));
                        lines++;
                        y++;
                    }
                }
                
                if(lines > 0) {
                    this.combo++;
                    let damage = 0;
                    
                    if(activeMutator === 'sniper') {
                        if(lines === 4) { // FIRE
                            damage = Math.floor(this.ammo * 1.5);
                            this.ammo = 0;
                        } else { // RELOAD
                            this.ammo = Math.min(10, this.ammo + lines);
                        }
                        this.updateMag();
                    } else {
                        // STANDARD / DOUBLE HOLD
                        if(lines === 4) damage = 4;
                        else damage = lines - 1;
                        if(this.combo > 0) damage += Math.floor((this.combo - 1) / (activeMutator==='double_hold' ? 3 : 2));
                    }

                    if(damage > 0) {
                        this.sent += damage;
                        if(socket && gameMode!=='zen') socket.emit('send_garbage', {amount: damage});
                        document.getElementById('s-sent').innerText = this.sent;
                    }
                } else {
                    this.combo = -1;
                }
            }

            recv(n) {
                // Simplified garbage
                // Ideally this adds gray lines at bottom
            }

            updateMag() {
                const m = document.getElementById('sniper-mag');
                m.innerHTML = '';
                for(let i=0; i<this.ammo; i++) {
                    const b = document.createElement('div');
                    b.className = 'mag-bullet';
                    m.appendChild(b);
                }
            }

            draw() {
                this.ctx.fillStyle='#000'; this.ctx.fillRect(0,0,120,900);
                this.ctx.fillStyle='rgba(255,0,0,0.2)'; this.ctx.fillRect(0,0,120,120);
                
                // Grid
                this.grid.forEach((row,y) => row.forEach((col,x) => {
                    if(col) { this.ctx.fillStyle=col; this.ctx.fillRect(x*30, y*30, 29, 29); }
                }));

                // Ghost
                let ghostY = this.active.pos.y;
                while(!this.collide(0, 1 + (ghostY - this.active.pos.y))) ghostY++;
                
                this.active.mat.forEach((row, y) => row.forEach((v, x) => {
                    if(v) {
                        this.ctx.fillStyle = 'rgba(255,255,255,0.2)';
                        this.ctx.fillRect((this.active.pos.x+x)*30, (ghostY+y)*30, 29, 29);
                        this.ctx.fillStyle = this.active.col;
                        this.ctx.fillRect((this.active.pos.x+x)*30, (this.active.pos.y+y)*30, 29, 29);
                    }
                }));
            }

            drawSide() {
                [this.hCtx, this.nCtx].forEach(c => c.clearRect(0,0,150,400));
                
                // Draw Hold(s)
                const holds = [this.holdId];
                if(activeMutator === 'double_hold') holds.push(this.hold2);
                
                holds.forEach((pid, i) => {
                    if(pid !== null) {
                        const p = PIECES[pid];
                        this.hCtx.fillStyle = COLORS[pid];
                        p.forEach((r,y) => r.forEach((v,x) => {
                            if(v) this.hCtx.fillRect(40 + x*20, 20 + i*60 + y*20, 19, 19);
                        }));
                    }
                });

                // Draw Next
                this.queue.slice(0, 3).forEach((pid, i) => {
                    const p = PIECES[pid];
                    this.nCtx.fillStyle = COLORS[pid];
                    p.forEach((r,y) => r.forEach((v,x) => {
                        if(v) this.nCtx.fillRect(40 + x*20, 20 + i*80 + y*20, 19, 19);
                    }));
                });
            }
        }

        p1 = new Player();
        
        let dropCounter = 0;
        let lastTime = 0;
        function loop(time=0) {
            const dt = time - lastTime;
            lastTime = time;
            
            if(gameActive) {
                dropCounter += dt;
                if(dropCounter > 700) {
                    p1.active.pos.y++;
                    if(p1.collide()) p1.active.pos.y--;
                    dropCounter = 0;
                    p1.draw();
                }
                requestAnimationFrame(loop);
            }
        }

        window.addEventListener('keydown', e => {
            if(!gameActive || inputLocked) return;
            switch(e.code) {
                case 'ArrowLeft': p1.move(-1); break;
                case 'ArrowRight': p1.move(1); break;
                case 'ArrowDown': p1.active.pos.y++; if(p1.collide()) p1.active.pos.y--; p1.draw(); break;
                case 'ArrowUp': p1.rotate(); break;
                case 'Space': p1.hardDrop(); break;
                case 'ShiftLeft': p1.hold(1); break;
                case 'ControlLeft': case 'Tab': 
                    e.preventDefault(); 
                    p1.hold(2); 
                    break;
            }
        });
    </script>
</body>
</html>
